<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>A Study in Blue</title>
  <meta name="description" content="Note: I am a lazy fuck and I have been putting off this post for a while so I just dumped some stuff in my text editor and put it up. I plan to refine this p...">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,700|Droid+Serif:400,700' rel='stylesheet' type='text/css'>
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/pwn/exploit/bluetooth/2019/07/31/bluetooth-pwning/">
  <link rel="alternate" type="application/rss+xml" title="See you, %20 cowboy" href="http://localhost:4000/feed.xml">

  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
</head>


  <body>
    <div class="site-wrap">
      <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="http://localhost:4000/">See you, %20 cowboy</a>
    <span class="site-description">A most excellent adventure in hacking</span>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        

        <a href="/feed.xml" class="page-link">RSS</a>
      </div>
    </nav>
  </div>
</header>


      <div class="page-content">
        <div class="wrapper">
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">A Study in Blue</h1>
    <p class="post-meta"><time datetime="2019-07-31T17:00:00-07:00" itemprop="datePublished">July 31, 2019</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Note: I am a lazy fuck and I have been putting off this post for a while so I just dumped some stuff in my text editor and put it up. I plan to refine this periodically over time. I will leave notes here while I update it. If this stuff is useful to you and you are running into problems setting stuff up or whatever, PM me on twitter.</p>

<p>I started digging into bluetooth stacks after Armis announced its series of vulnerabilities affecting Linux, Android, iOS, and Windows, which they named <a href="https://www.armis.com/blueborne/">Bluebourne</a>. This paper <a href="https://go.armis.com/hubfs/BlueBorne%20Technical%20White%20Paper-1.pdf">explaining the vulnerabilities</a> as well as the follow up <a href="https://go.armis.com/hubfs/BlueBorne%20-%20Android%20Exploit%20(20171130).pdf">explaining the exploitation</a> were very well written and I highly recommend you take a look at them. If you want to run their POC, you can check it out <a href="https://github.com/ArmisSecurity/blueborne">here</a>, and if you want to adopt this POC to your device, take a look at <a href="https://jesux.es/exploiting/blueborne-android-6.0.1-english/">this</a>.</p>

<p>Trying to make sense of these disclosed vulnerabilities, along with their POCs, I tried to find some online resources to help me out. There were a lot of interesting projects dealing with the application layer of bluetooth and how applications which use this technology expose themselves to potential issues. But, there was very little in the way of analyzing the actual bluetooth stack which enables these higher level applications.</p>

<p>TODO: resources that I found.</p>

<p>I initially wanted to be able to speak the protocol in hopes I could write a fuzzer or something to shake some bugs out of bluetooth stack code. Bluekitchen’s bluetooth documentation and implementation helped immensely as I had a means of sending data to a target device.</p>

<p>I searched for vulnerabilities in Android for a while with no luck. But over the period of time in this research I learned a great deal about Bluetooth and watched as seasoned bug finding veterans crushed this source code.</p>

<p>The initial post I want to make will just outline different components of Bluetooth and how they relate to each other. Additionally, I want to point out the attack surface of these components and vulnerabilities in these components within their implementation (mostly Android).</p>

<p>I will be following this post up with some helpful instructions for running and debugging Bluetooth POCs to help with your own bug hunting.</p>

<h1 id="bluetooth-enabled-things">Bluetooth enabled things</h1>
<p>A bunch of things use bluetooth, here are some stack implementations I am aware of:</p>
<ul>
  <li>MacOS Stack - written in objc</li>
  <li>iOS Stack - written in c</li>
  <li>Android (fluoride)</li>
  <li>BTStack</li>
  <li>mynewt</li>
  <li>nimble - zephyr</li>
  <li>Windows</li>
  <li>Toshiba</li>
  <li>Linux (bluez)</li>
  <li>Car entertainment systems</li>
</ul>

<h1 id="hci">HCI</h1>

<h2 id="notable-features">Notable features</h2>
<ul>
  <li>Interfaces with the bluetooth controller - For example, whenever a packet is sent, the controller will tell the stack how many packets were sent via HCI (TODO image)</li>
  <li><a href="https://sourcegraph.com/github.com/secdev/scapy/-/blob/scapy/layers/bluetooth.py#L155">Scapy</a></li>
  <li>The difference between BR/EDR and LE</li>
  <li><a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gap">GAP for LE</a></li>
  <li>A common naming convention for packet buffers is <code class="highlighter-rouge">pdu</code> (<a href="https://en.wikipedia.org/wiki/Protocol_data_unit">protocol data unit</a>)</li>
  <li>For l2cap, HCI creates <code class="highlighter-rouge">handles</code> which it passes up after a successful connection</li>
  <li>Link Manager Protocol (LMP) is also worth mentioning here as it “The Link Manager carries out link setup, authentication, link configuration and other protocols. It discovers other remote LM’s and communicates with them via the Link Manager Protocol (LMP).” (<a href="https://www.amd.e-technik.uni-rostock.de/ma/gol/lectures/wirlec/bluetooth_info/lmp.html">info</a>)</li>
  <li><a href="https://bluekitchen-gmbh.com/btstack/profiles/#gap-generic-access-profile-classic">GAP</a></li>
  <li><a href="https://bluekitchen-gmbh.com/btstack/profiles/#gap-le-generic-access-profile-for-low-energy">GAP LE</a></li>
</ul>

<h2 id="attack-surface">Attack Surface</h2>
<ul>
  <li>Not a whole lot going on since this layer is just in charge of talking to a controller and passing data along to higher levels</li>
  <li>ECC attack for MiTM (TODO: Link)</li>
  <li>What is interesting about the attack surface is that for each protocol, Android has a server and a client. For example, the Android phone can receive and parse SDP packets, as well as send them to a device it is in the process of connecting to. While we would typically need to find some triggering condition to have the client issue requests from us and parse their response, this is an interesting attack surface as it might be less likely developers will think about the security of parsing the response from the server. As we will see in the various protocol client applications, this was indeed the case.</li>
</ul>

<h2 id="stack-implementations">Stack Implementations</h2>
<p><a href="https://sourcegraph.com/github.com/secdev/scapy/-/blob/scapy/layers/bluetooth.py#L155">Scapy</a>
Scapy gives a nice overview of how packets are structured, but because of the weirdness of the bluetooth protocol, this information only gets you so far.</p>

<p>If you want to dig into the details of Bluetooth, I recommend looking through Bluekitchen’s btstack. Here is BTStack’s main hci <a href="https://github.com/bluekitchen/btstack/blob/d966a453850a16585ca5c468190532d5cbf0d844/src/hci.c#L1856">event handler</a>.</p>

<p>HCI is not entirely interesting, it is mainly used for configuring the Bluetooth controller, creating/configuring connections and sending/receiving data to devices (power on, off, start advertising le data, create connection). (TODO: Link to btstack hci_cmd.c)</p>

<p>More information on HCI can be found <a href="https://bluekitchen-gmbh.com/btstack/protocols/#hci-host-controller-interface">here</a></p>

<h2 id="cves">CVEs</h2>
<p>I don’t know if there are any?</p>

<h1 id="l2cap">L2CAP</h1>

<h2 id="notable-features-1">Notable features</h2>
<ul>
  <li>Basically the TCP of Bluetooth
    <ul>
      <li>Packet retransmission/reassembly - potentially sketchy code (TODO link to different implementations)</li>
      <li>Both client and server send each other their <code class="highlighter-rouge">mtu</code>s (max transmission unit) to specify how much data they can send (one of the vulnerabilities in the BlueBourne research used this to trigger a vuln TODO: link)</li>
    </ul>
  </li>
  <li>Static vs. Dynamic channels
    <ul>
      <li>There are some pre-defined ranges by the bluetooth standard</li>
      <li>The channels are different for br/edr and le connections</li>
      <li>A protocol is identified by a <code class="highlighter-rouge">psm</code> (e.g. SDP has psm 1, ATT has psm 7, a really good list can be found in bluez’s sdptool sdptool.c:259, when we get to SDP we will look at this more)</li>
      <li>After connecting to a protocol, the are given a <code class="highlighter-rouge">cid</code> (channel id) which lets you send acl (data) packets to</li>
    </ul>
  </li>
  <li>Signalling Channel
    <ul>
      <li>The entrypoint for creating and configuring channels with a remote device (btstack l2cap_signalling.c:53)</li>
    </ul>
  </li>
  <li>classic (br/edr) and low-energy (le) exist in l2cap, their code paths somewhat merge
    <ul>
      <li>This can be seen in btstack/src/l2cap.c:3443</li>
    </ul>
  </li>
</ul>

<h2 id="attack-surface-1">Attack Surface</h2>
<ul>
  <li>Channels and their state are created and stored within the stack, abusing the state machine could lead to use-after-frees</li>
</ul>

<p>TODO: Go through each bluetooth stack and show what channels are registered (point out the weird iOS stuff)</p>

<h2 id="stack-comparisions">Stack Comparisions</h2>

<h2 id="cves-1">CVEs</h2>
<ul>
  <li>CVE-2017-0781 RCE (Allocate buffers of the right size when BT_HDR is included) <a href="https://android.googlesource.com/platform/system/bt/+/c513a8ff5cfdcc62cc14da354beb1dd22e56be0e">diff</a>
    <ul>
      <li>Vuln used by Bluebourne in their exploit POC, the code when run would cause a heap overflow due to the allocation being too small</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="n">p_bcb</span><span class="o">-&gt;</span><span class="n">p_pending_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">BT_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">osi_malloc</span><span class="p">(</span><span class="n">rem_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BT_HDR</span><span class="p">));</span>
  <span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_bcb</span><span class="o">-&gt;</span><span class="n">p_pending_data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="n">rem_len</span><span class="p">);</span>
  </code></pre></figure>

<ul>
  <li>CVE-2018-9359 Fix OOB read in process_l2cap_cmd (signalling commands ID) <a href="https://android.googlesource.com/platform/system/bt/+/b66fc16410ff96e9119f8eb282e67960e79075c8">diff</a>
    <ul>
      <li>Pretty much no signalling commands were checking minimum length and variables read from the packet were sent back to the user</li>
      <li>Check out the <a href="https://blog.quarkslab.com/a-story-about-three-bluetooth-vulnerabilities-in-android.html">Quarkslab writeup</a></li>
    </ul>
  </li>
  <li>CVE-2018-9419	l2c ble ID <a href="https://android.googlesource.com/platform/system/bt/+/f1c2c86080bcd7b3142ff821441696fc99c2bc9a">diff</a>
    <ul>
      <li>End of packet is not checked, bytes can be leaked</li>
      <li>Check out the <a href="https://blog.quarkslab.com/a-story-about-three-bluetooth-vulnerabilities-in-android.html">Quarkslab writeup</a></li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">     <span class="k">case</span> <span class="n">L2CAP_CMD_DISC_REQ</span><span class="p">:</span>
<span class="o">+</span>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">p_pkt_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"74121659"</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>      <span class="p">}</span></code></pre></figure>

<ul>
  <li>CVE-2018-9555	l2cap RCE <a href="https://android.googlesource.com/platform/system/bt/+/02fc52878d8dba16b860fbdf415b6e4425922b2c">diff</a>
    <ul>
      <li>This code is difficult to hit as you need to have an LE data channel listening for connections (most LE connections interact with GATT)</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sdu_length</span> <span class="o">&lt;</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">L2CAP_TRACE_ERROR</span><span class="p">(</span><span class="s">"%s: Invalid sdu_length: %d"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sdu_length</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">android_errorWriteWithInfoLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"112321180"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="o">+</span>      <span class="cm">/* Discard the buffer */</span>
<span class="o">+</span>      <span class="n">osi_free</span><span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>    <span class="p">}</span></code></pre></figure>

<ul>
  <li>ble l2cap retransmission RCE (regression of CVE-2018-9555) <a href="https://android.googlesource.com/platform/system/bt/+/488aa8befd5bdffed6cfca7a399d2266ffd201fb">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">l2c_lcc_proc_pdu</span><span class="p">(</span><span class="n">tL2C_CCB</span><span class="o">*</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="n">BT_HDR</span><span class="o">*</span> <span class="n">p_buf</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">sdu_length</span><span class="p">;</span>
  <span class="cm">/* Buffer length should not exceed local mps */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">local_conn_cfg</span><span class="p">.</span><span class="n">mps</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Discard the buffer */</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">is_first_seg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If we do not have this check, then p_buf-&gt;len can be 0 or 1
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdu_length</span><span class="p">))</span> <span class="p">{</span>
      <span class="cm">/* Discard the buffer */</span>
    <span class="p">}</span>

    <span class="n">STREAM_TO_UINT16</span><span class="p">(</span><span class="n">sdu_length</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="cm">/* Check the SDU Length with local MTU size */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sdu_length</span> <span class="o">&gt;</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">local_conn_cfg</span><span class="p">.</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* Discard the buffer */</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sdu_length</span> <span class="o">&lt;</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* Discard the buffer */</span>
    <span class="p">}</span>
    <span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">BT_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">osi_malloc</span><span class="p">(</span><span class="n">BT_HDR_SIZE</span> <span class="o">+</span> <span class="n">sdu_length</span><span class="p">);</span>

    <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdu_length</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// p_buf-&gt;len could be super huge
</span>  <span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
         <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9485	L2ble OOB read <a href="https://android.googlesource.com/platform/system/bt/+/bdbabb2ca4ebb4dc5971d3d42cb12f8048e23a23">diff</a>
    <ul>
      <li>End of packet is never checked for an le l2cap configuration request</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">   <span class="n">p_pkt_end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">pkt_len</span><span class="p">;</span>

<span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">p_pkt_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"80261585"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"invalid read"</span><span class="p">;</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="n">STREAM_TO_UINT8</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
   <span class="n">STREAM_TO_UINT8</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
   <span class="n">STREAM_TO_UINT16</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9486 l2cap check length <a href="https://android.googlesource.com/platform/system/bt/+/bc6aef4f29387d07e0c638c9db810c6c1193f75b">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">hidh_l2cif_data_ind</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">l2cap_cid</span><span class="p">,</span> <span class="n">BT_HDR</span><span class="o">*</span> <span class="n">p_msg</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
<span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">HIDH_TRACE_WARNING</span><span class="p">(</span><span class="s">"Rcvd L2CAP data, invalid length %d, should be &gt;= 1"</span><span class="p">,</span>
<span class="o">+</span>                       <span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">osi_free</span><span class="p">(</span><span class="n">p_msg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"80493272"</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="n">ttype</span> <span class="o">=</span> <span class="n">HID_GET_TRANS_FROM_HDR</span><span class="p">(</span><span class="o">*</span><span class="n">p_data</span><span class="p">);</span> <span class="c1">// p_data has data from the server that will get leaked
</span>   <span class="n">param</span> <span class="o">=</span> <span class="n">HID_GET_PARAM_FROM_HDR</span><span class="p">(</span><span class="o">*</span><span class="n">p_data</span><span class="p">);</span>
   <span class="n">rep_type</span> <span class="o">=</span> <span class="n">param</span> <span class="o">&amp;</span> <span class="n">HID_PAR_REP_TYPE_MASK</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9484 Out of Bounds read in l2cap <a href="https://android.googlesource.com/platform/system/bt/+/d5b44f6522c3294d6f5fd71bc6670f625f716460">diff</a>
    <ul>
      <li>you can position p and get data out</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">((</span><span class="n">cfg_len</span> <span class="o">+</span> <span class="n">L2CAP_CFG_OPTION_OVERHEAD</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">cfg_len</span> <span class="o">&gt;</span> <span class="n">p_next_cmd</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></code></pre></figure>

<ul>
  <li><a href="https://www.cymotive.com/wp-content/uploads/2019/03/Hell2CAP-0day.pdf">Hell2cap</a> (stupid named vulns :P)</li>
  <li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Nie-Free-Fall-Hacking-Tesla-From-Wireless-To-CAN-Bus-wp.pdf">Tesla Keen Team report</a></li>
</ul>

<h2 id="interactive-example">Interactive Example</h2>
<p>Let’s run through an example POC</p>

<p>// TODO</p>

<h1 id="sm-and-smp">SM and SMP</h1>

<h2 id="smp---notable-features">SMP - Notable Features</h2>
<ul>
  <li>Capabilities and security levels
Security Levels:
<a href="https://sourcegraph.com/github.com/bluekitchen/btstack@develop/-/blob/src/l2cap.c#L2232:64">btstack</a>
<a href="https://android.googlesource.com/platform/system/bt/+/refs/heads/master/stack/btm/btm_sec.cc#2248">fluoride</a>
<a href="https://github.com/apache/mynewt-nimble/blob/2d3705b94f7b5d2493c71abb5ba4d33b3d763735/apps/bttester/src/gap.c#L1079">nimble</a>
<a href="https://sourcegraph.com/github.com/torvalds/linux@master/-/blob/net/bluetooth/l2cap_core.c#L815">bluez</a></li>
</ul>

<h2 id="sm---notable-features">SM - Notable Features</h2>
<p>// TODO</p>

<h2 id="cves-2">CVEs</h2>
<h3 id="android">Android</h3>
<ul>
  <li>CVE-2019-1991	RCE in SMP <a href="https://android.googlesource.com/platform/system/bt/+/3d21e75aa8c1e0c4adf178a1330f9f5c573ca045">diff</a></li>
  <li>CVE-2018-9507	ID in SMP <a href="https://android.googlesource.com/platform/system/bt/+/e8bbf5b0889790cf8616f4004867f0ff656f0551">diff</a></li>
  <li>CVE-2018-9509	ID in SMP <a href="https://android.googlesource.com/platform/system/bt/+/198888b8e0163bab7a417161c63e483804ae8e31">diff</a></li>
  <li>CVE-2018-9510	ID in SMP <a href="https://android.googlesource.com/platform/system/bt/+/6e4b8e505173f803a5fc05abc09f64eef89dc308">diff</a></li>
  <li>CVE-2018-9446 RCE SMP (Check p_cb-&gt;role in smp_br_state_machine_event) <a href="https://android.googlesource.com/platform/system/bt/+/49acada519d088d8edf37e48640c76ea5c70e010">diff</a>
    <ul>
      <li>Attacker supplied p_cb-&gt;role had ended up being used to lookup index in smp_br_state_table, letting you specify what function you wanted to call</li>
      <li>also in <a href="https://android.googlesource.com/platform/system/bt/+/ae94a4c333417a1829030c4d87a58ab7f1401308">CVE-2018-9365</a></li>
      <li>This was discovered by <a href="https://blog.quarkslab.com/a-story-about-three-bluetooth-vulnerabilities-in-android.html">Quarkslab</a></li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">&gt;</span> <span class="n">HCI_ROLE_SLAVE</span><span class="p">)</span> <span class="p">{</span> <span class="o">--&gt;</span> <span class="n">state_table</span> <span class="o">=</span> <span class="n">smp_br_state_table</span><span class="p">[</span><span class="n">curr_state</span><span class="p">][</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">];</span></code></pre></figure>

<ul>
  <li>SMP <a href="https://android.googlesource.com/platform/system/bt/+/fe621261a1f66463df71cfef2bdd037374e3c6b2">use after free</a></li>
</ul>

<h1 id="sdp">SDP</h1>

<p>This is probably the most sketch protocol in Bluetooth. There is a lot going on with the protocol and it is required to be exposed to all devices so they know what applications the device has registered (e.g. can I send music to you? yes! I have AV controller!). Granted, devices that operate only with BLE do not have this since information is advertised via GATT. However, all mobile devices, cars, and things that need compatability with older protocols will be listening for SDP</p>

<h2 id="notable-features-2">Notable Features</h2>
<ul>
  <li>The SDP <code class="highlighter-rouge">server</code> handles remote queries of the SDP database which contains information for all registered services for the device. For example…
    <ul>
      <li>Each Bluetooth protocol is assigned a specific number defined by the <a href="https://www.bluetooth.com/specifications/assigned-numbers/service-discovery/">specification</a></li>
      <li>Higher level applications register themselves to the <code class="highlighter-rouge">server</code> via the internal SDP API the server exposes (as seen here in btstack for PAN: ). These applications identify themselves to remote devices using <code class="highlighter-rouge">service class identifiers</code> (<a href="https://git.kernel.org/pub/scm/bluetooth/bluez.git/tree/lib/sdp.h#n78">Bluez</a>)</li>
      <li>Each of these higher level protocols use different <code class="highlighter-rouge">data elements</code> (below) to convey to a remote device how the application is configured (metadata about the bluetooth application), these are identified by <code class="highlighter-rouge">service attribute definitions</code> (seen here in <a href="https://git.kernel.org/pub/scm/bluetooth/bluez.git/tree/lib/sdp.h#n250">Bluez</a>). For example, here is the SDP registration specification for PAN. We can see btstack specifically parsing an RFCOMM SDP entry: <code class="highlighter-rouge">examples/sdp_rfcomm_query.c</code></li>
    </ul>
  </li>
  <li>The SDP <code class="highlighter-rouge">client</code> performs queries and parses their response</li>
  <li>There are three different queries which can be performed: (TODO fill in these details)
    <ul>
      <li>ServiceSearchRequest</li>
      <li>ServiceAttributeRequest</li>
      <li>ServiceSearchAttributeRequest</li>
    </ul>
  </li>
  <li>Queries are comprised of <code class="highlighter-rouge">data elements</code> which are type, length, value structures (seen here: btstack sdp_util.h:105)
    <ul>
      <li>These <code class="highlighter-rouge">data elements</code></li>
    </ul>
  </li>
  <li>
    <p>The parsing is relatively complex, I think bluez’s implementation is the <a href="https://git.kernel.org/pub/scm/bluetooth/bluez.git/tree/lib/sdp.c">clearest</a></p>
  </li>
  <li>If a response is too big, a <code class="highlighter-rouge">continuation state</code> is created (TODO: Reference specification)
    <ul>
      <li>This <code class="highlighter-rouge">continuation state</code> has led to a number of vulnerabilities with Android (TODO: refs) due to the server either trusting the client’s state or the internal state becomes corrupt and lengths become out of sync (TODO: ref bluebourne exploit leak)</li>
    </ul>
  </li>
</ul>

<h2 id="attack-surface-2">Attack Surface</h2>
<ul>
  <li>Since every device must always expose their SDP server (allow JustWorks pairing, see HCI/L2cap) to all nearby devices to tell them what sevices are accessible on the device, this provides a nice no-interaction attack surface. Additionally, a given bluetooth stack might have some sort of automated trigger (see iOS Airpod discovery) which causes it to use its SDP client to send a request and parse a response from the attacker’s device. Again, a no-interaction needed attack surface.</li>
  <li>The SDP protocol is sufficiently complex to most likely contain bugs in any implementation, as shown in researchers digging through Android.</li>
</ul>

<p>TODO: Run sdp tool on each stack</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  libusb-intel git:<span class="o">(</span>fuzzable<span class="o">)</span> ✗ <span class="nb">sudo</span> ./sdp_l2cap_scan <span class="nt">--address</span> 38:CA:DA:85:5F:E1
Packet Log: /tmp/hci_dump.pklg
USB Path: 07
Client HCI init <span class="k">done
</span>BTstack up and running on 18:56:80:04:42:72.

<span class="nt">---</span>
Record nr. 0
sdp attribute: 0x0004
summary: uuid 0x0003, l2cap_psm: 0x0000

<span class="nt">---</span>
Record nr. 1
sdp attribute: 0x0004
summary: uuid 0x0100, l2cap_psm: 0x000f, name: BNEP
summary: uuid 0x000f, l2cap_psm: 0x0100, name: L2CAP

<span class="nt">---</span>
Record nr. 2
sdp attribute: 0x0004
summary: uuid 0x0003, l2cap_psm: 0x0000

<span class="nt">---</span>
Record nr. 3
sdp attribute: 0x0004
summary: uuid 0x0003, l2cap_psm: 0x0000

<span class="nt">---</span>
Record nr. 4
sdp attribute: 0x0004
summary: uuid 0x0100, l2cap_psm: 0x0017, name: AVCTP
summary: uuid 0x0017, l2cap_psm: 0x0104

<span class="nt">---</span>
Record nr. 5
sdp attribute: 0x0004
summary: uuid 0x0100, l2cap_psm: 0x0017, name: AVCTP
summary: uuid 0x0017, l2cap_psm: 0x0104

<span class="nt">---</span>
Record nr. 6
sdp attribute: 0x0004
summary: uuid 0x0100, l2cap_psm: 0x0019, name: AVDTP
summary: uuid 0x0019, l2cap_psm: 0x0103

<span class="nt">---</span>
Record nr. 7
sdp attribute: 0x0004
summary: uuid 0x0003, l2cap_psm: 0x0000

<span class="nt">---</span>
Record nr. 8
sdp attribute: 0x0004
summary: uuid 0x0003, l2cap_psm: 0x0000

<span class="nt">---</span></code></pre></figure>

<p>This code just dumps out relavant info for understanding the BR/EDR attack surface of a device. For a more comprehensive view of what data SDP holds, check out this full SDP dump for the same device:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  libusb-intel git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">sudo</span> ./sdp_general_query 
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>breadchris: 
Packet Log: /tmp/hci_dump.pklg
USB Path: 07
Done 0
Client HCI init <span class="k">done
</span>BTstack up and running on 18:56:80:04:42:72.

<span class="nt">---</span>
Record nr. 0
Attribute 0x0001: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
    <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001132
Attribute 0x0002: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  5 , value: 0x00000000
Attribute 0x0004: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 19 
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000100
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  7 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000003
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x00000002
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000008
Attribute 0x0005: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
    <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001002
Attribute 0x0006: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 38 
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000656e
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000100
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006672
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000110
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006465
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000120
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006a61
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000130
Attribute 0x0008: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x000000ff
Attribute 0x0009: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 10 
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  8 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001134
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000100
Attribute 0x0100: <span class="nb">type </span>STRING <span class="o">(</span>4<span class="o">)</span>, element len 13 len 11 <span class="o">(</span>0x0b<span class="o">)</span>
4D 41 50 20 4D 41 53 2D 69 4F 53 
Attribute 0x0315: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x00000000
Attribute 0x0316: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x0000000a

<span class="nt">---</span>
Record nr. 1
Attribute 0x0001: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
    <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001116
Attribute 0x0002: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  5 , value: 0x00000018
Attribute 0x0004: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 32 
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  8 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000100
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000000f
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 22 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x0000000f
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000100
        <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 14 
            <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000800
            <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000806
            <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00008100
            <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x000086dd
Attribute 0x0005: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
    <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001002
Attribute 0x0006: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 38 
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000656e
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000100
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006672
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000110
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006465
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000120
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00006a61
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000006a
    <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000130
Attribute 0x0008: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x00000000
Attribute 0x0009: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 10 
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  8 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00001116
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000100
Attribute 0x0100: <span class="nb">type </span>STRING <span class="o">(</span>4<span class="o">)</span>, element len 28 len 26 <span class="o">(</span>0x1a<span class="o">)</span>
50 41 4E 20 4E 65 74 77 6F 72 6B 20 41 63 63 65 73 73 20 50 72 6F 66 69 6C 65 
Attribute 0x0101: <span class="nb">type </span>STRING <span class="o">(</span>4<span class="o">)</span>, element len 22 len 20 <span class="o">(</span>0x14<span class="o">)</span>
4E 65 74 77 6F 72 6B 20 41 63 63 65 73 73 20 50 6F 69 6E 74 
Attribute 0x030a: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x00000001
Attribute 0x030b: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  3 , value: 0x0000000d
Attribute 0x030c: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  5 , value: 0x0003e800

<span class="nt">---</span>
Record nr. 2
Attribute 0x0001: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 19 
    <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len 17 , value: 02030302-1D19-415F-86F2-22A2106A0A77
Attribute 0x0002: <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  5 , value: 0x00000000
Attribute 0x0004: <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len 14 
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  5 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000100
    <span class="nb">type   </span>DES <span class="o">(</span>6<span class="o">)</span>, element len  7 
        <span class="nb">type  </span>UUID <span class="o">(</span>3<span class="o">)</span>, element len  3 , value: 0x00000003
        <span class="nb">type  </span>UINT <span class="o">(</span>1<span class="o">)</span>, element len  2 , value: 0x00000001
...</code></pre></figure>

<h2 id="cves-3">CVEs</h2>
<h3 id="android-1">Android</h3>
<ul>
  <li>CVE-2018-9478	SDP RCE <a href="https://android.googlesource.com/platform/system/bt/+/68688194eade113ad31687a730e8d4102ada58d5">diff</a>
    <ul>
      <li>Hard to exploit: You can cause memcpy to copy a huge amount of bytes onto the heap, but where you need to control data to write the heap cookie you aren’t able to control it.</li>
      <li>More details in the <a href="https://github.com/JiounDai/Bluedroid/blob/master/Dissect%20Android%20Bluetooth%20for%20Fun%20%26%20Profit.pdf">presentation</a></li>
    </ul>
  </li>
  <li>CVE-2018-9590	SDP ID <a href="https://android.googlesource.com/platform/system/bt/+/297598898683b81e921474e6e74c0ddaedbb8bb5">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">sdp</span><span class="o">/</span><span class="n">sdp_discovery</span><span class="p">.</span><span class="n">cc</span> <span class="n">b</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">sdp</span><span class="o">/</span><span class="n">sdp_discovery</span><span class="p">.</span><span class="n">cc</span>
<span class="n">index</span> <span class="mi">95</span><span class="n">f55bf</span><span class="p">..</span><span class="mi">1</span><span class="n">ca2ad3</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">sdp</span><span class="o">/</span><span class="n">sdp_discovery</span><span class="p">.</span><span class="n">cc</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">sdp</span><span class="o">/</span><span class="n">sdp_discovery</span><span class="p">.</span><span class="n">cc</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">55</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">save_attr_seq</span><span class="p">(</span><span class="n">tCONN_CB</span><span class="o">*</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_msg_end</span><span class="p">);</span>
 <span class="k">static</span> <span class="n">tSDP_DISC_REC</span><span class="o">*</span> <span class="n">add_record</span><span class="p">(</span><span class="n">tSDP_DISCOVERY_DB</span><span class="o">*</span> <span class="n">p_db</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">RawAddress</span><span class="o">&amp;</span> <span class="n">p_bda</span><span class="p">);</span>
<span class="o">-</span><span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">add_attr</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">tSDP_DISCOVERY_DB</span><span class="o">*</span> <span class="n">p_db</span><span class="p">,</span>
<span class="o">+</span><span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">add_attr</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_end</span><span class="p">,</span> <span class="n">tSDP_DISCOVERY_DB</span><span class="o">*</span> <span class="n">p_db</span><span class="p">,</span>
                          <span class="n">tSDP_DISC_REC</span><span class="o">*</span> <span class="n">p_rec</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">attr_id</span><span class="p">,</span>
                          <span class="n">tSDP_DISC_ATTR</span><span class="o">*</span> <span class="n">p_parent_attr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">nest_level</span><span class="p">);</span>
 
<span class="err">@@</span> <span class="o">-</span><span class="mi">770</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">770</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
     <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">attr_id</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
 
     <span class="cm">/* Now, add the attribute value */</span>
<span class="o">-</span>    <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="n">attr_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_seq_end</span><span class="p">,</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="n">attr_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"SDP - DB full add_attr"</span><span class="p">);</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">830</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">830</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
  <span class="o">*</span> <span class="n">Returns</span>          <span class="n">pointer</span> <span class="n">to</span> <span class="n">next</span> <span class="n">byte</span> <span class="n">in</span> <span class="n">data</span> <span class="n">stream</span>
  <span class="o">*</span>
  <span class="o">*****************************************************************************</span><span class="err">*/</span>
<span class="o">-</span><span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">add_attr</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">tSDP_DISCOVERY_DB</span><span class="o">*</span> <span class="n">p_db</span><span class="p">,</span>
<span class="o">+</span><span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">add_attr</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_end</span><span class="p">,</span> <span class="n">tSDP_DISCOVERY_DB</span><span class="o">*</span> <span class="n">p_db</span><span class="p">,</span>
                          <span class="n">tSDP_DISC_REC</span><span class="o">*</span> <span class="n">p_rec</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">attr_id</span><span class="p">,</span>
                          <span class="n">tSDP_DISC_ATTR</span><span class="o">*</span> <span class="n">p_parent_attr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">nest_level</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">tSDP_DISC_ATTR</span><span class="o">*</span> <span class="n">p_attr</span><span class="p">;</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">839</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">839</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
   <span class="kt">uint16_t</span> <span class="n">attr_type</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">id</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="n">type</span><span class="p">;</span>
<span class="o">-</span>  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_end</span><span class="p">;</span>
<span class="o">+</span>  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_attr_end</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="n">is_additional_list</span> <span class="o">=</span> <span class="n">nest_level</span> <span class="o">&amp;</span> <span class="n">SDP_ADDITIONAL_LIST_MASK</span><span class="p">;</span>
 
   <span class="n">nest_level</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SDP_ADDITIONAL_LIST_MASK</span><span class="p">);</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">856</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">856</span><span class="p">,</span><span class="mi">13</span> <span class="err">@@</span>
   <span class="k">else</span>
     <span class="n">total_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tSDP_DISC_ATTR</span><span class="p">);</span>
 
<span class="o">+</span>  <span class="n">p_attr_end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">;</span>
<span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_attr_end</span> <span class="o">&gt;</span> <span class="n">p_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"115900043"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"%s: SDP - Attribute length beyond p_end"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="cm">/* Ensure it is a multiple of 4 */</span>
   <span class="n">total_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
 
<span class="err">@@</span> <span class="o">-</span><span class="mi">879</span><span class="p">,</span><span class="mi">18</span> <span class="o">+</span><span class="mi">886</span><span class="p">,</span><span class="mi">17</span> <span class="err">@@</span>
            <span class="o">*</span> <span class="n">sub</span><span class="o">-</span><span class="n">attributes</span> <span class="err">*/</span>
           <span class="n">p_db</span><span class="o">-&gt;</span><span class="n">p_free_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tSDP_DISC_ATTR</span><span class="p">);</span>
           <span class="n">p_db</span><span class="o">-&gt;</span><span class="n">mem_free</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tSDP_DISC_ATTR</span><span class="p">);</span>
<span class="o">-</span>          <span class="n">p_end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">;</span>
           <span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
           <span class="cm">/* SDP_TRACE_DEBUG ("SDP - attr nest level:%d(list)", nest_level); */</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">nest_level</span> <span class="o">&gt;=</span> <span class="n">MAX_NEST_LEVELS</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">SDP_TRACE_ERROR</span><span class="p">(</span><span class="s">"SDP - attr nesting too deep"</span><span class="p">);</span>
<span class="o">-</span>            <span class="k">return</span> <span class="p">(</span><span class="n">p_end</span><span class="p">);</span>
<span class="o">+</span>            <span class="k">return</span> <span class="n">p_attr_end</span><span class="p">;</span>
           <span class="p">}</span>
 
           <span class="cm">/* Now, add the list entry */</span>
<span class="o">-</span>          <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="n">ATTR_ID_PROTOCOL_DESC_LIST</span><span class="p">,</span> <span class="n">p_attr</span><span class="p">,</span>
<span class="o">-</span>                       <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">nest_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="o">+</span>          <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_end</span><span class="p">,</span> <span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="n">ATTR_ID_PROTOCOL_DESC_LIST</span><span class="p">,</span>
<span class="o">+</span>                       <span class="n">p_attr</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">nest_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
 
           <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">949</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">955</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
           <span class="k">break</span><span class="p">;</span>
         <span class="k">default</span><span class="o">:</span>
           <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"SDP - bad len in UUID attr: %d"</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">);</span>
<span class="o">-</span>          <span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">);</span>
<span class="o">+</span>          <span class="k">return</span> <span class="n">p_attr_end</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">break</span><span class="p">;</span>
 
<span class="err">@@</span> <span class="o">-</span><span class="mi">959</span><span class="p">,</span><span class="mi">22</span> <span class="o">+</span><span class="mi">965</span><span class="p">,</span><span class="mi">22</span> <span class="err">@@</span>
        <span class="o">*</span> <span class="n">sub</span><span class="o">-</span><span class="n">attributes</span> <span class="err">*/</span>
       <span class="n">p_db</span><span class="o">-&gt;</span><span class="n">p_free_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tSDP_DISC_ATTR</span><span class="p">);</span>
       <span class="n">p_db</span><span class="o">-&gt;</span><span class="n">mem_free</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tSDP_DISC_ATTR</span><span class="p">);</span>
<span class="o">-</span>      <span class="n">p_end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">;</span>
       <span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
       <span class="cm">/* SDP_TRACE_DEBUG ("SDP - attr nest level:%d", nest_level); */</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">nest_level</span> <span class="o">&gt;=</span> <span class="n">MAX_NEST_LEVELS</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SDP_TRACE_ERROR</span><span class="p">(</span><span class="s">"SDP - attr nesting too deep"</span><span class="p">);</span>
<span class="o">-</span>        <span class="k">return</span> <span class="p">(</span><span class="n">p_end</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">return</span> <span class="n">p_attr_end</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">is_additional_list</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
           <span class="n">attr_id</span> <span class="o">==</span> <span class="n">ATTR_ID_ADDITION_PROTO_DESC_LISTS</span><span class="p">)</span>
         <span class="n">nest_level</span> <span class="o">|=</span> <span class="n">SDP_ADDITIONAL_LIST_MASK</span><span class="p">;</span>
       <span class="cm">/* SDP_TRACE_DEBUG ("SDP - attr nest level:0x%x(finish)", nest_level); */</span>
 
<span class="o">-</span>      <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_attr_end</span><span class="p">)</span> <span class="p">{</span>
         <span class="cm">/* Now, add the list entry */</span>
<span class="o">-</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p_attr</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">nest_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="o">+</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">add_attr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_end</span><span class="p">,</span> <span class="n">p_db</span><span class="p">,</span> <span class="n">p_rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p_attr</span><span class="p">,</span>
<span class="o">+</span>                     <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">nest_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
 
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
       <span class="p">}</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">992</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">998</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
           <span class="k">break</span><span class="p">;</span>
         <span class="k">default</span><span class="o">:</span>
           <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"SDP - bad len in boolean attr: %d"</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">);</span>
<span class="o">-</span>          <span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">);</span>
<span class="o">+</span>          <span class="k">return</span> <span class="n">p_attr_end</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">break</span><span class="p">;</span>
 </code></pre></figure>

<ul>
  <li>CVE-2018-9566	SDP ID <a href="https://android.googlesource.com/platform/system/bt/+/314336a22d781f54ed7394645a50f74d6743267d">diff</a>
    <ul>
      <li>No length check</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_reply</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">p_reply_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"74249842"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">sdp_disconnect</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">SDP_GENERIC_ERROR</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
   <span class="cm">/* Skip transaction, and param len */</span>
   <span class="n">p_reply</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
   <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">p_reply</span><span class="p">);</span>
<span class="c1">// ...
</span><span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_reply</span> <span class="o">+</span> <span class="p">((</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">num_handles</span> <span class="o">-</span> <span class="n">orig</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">p_reply_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"74249842"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">sdp_disconnect</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">SDP_GENERIC_ERROR</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">xx</span> <span class="o">=</span> <span class="n">orig</span><span class="p">;</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">num_handles</span><span class="p">;</span> <span class="n">xx</span><span class="o">++</span><span class="p">)</span>
     <span class="n">BE_STREAM_TO_UINT32</span><span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">p_reply</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9562	SDP ID in client <a href="https://android.googlesource.com/platform/system/bt/+/1bb14c41a72978c6075c5753a8301ddcbb10d409">diff</a>
    <ul>
      <li>This one is actually pretty interesting. <code class="highlighter-rouge">num_uuid</code> was previously set to 2 which when copying from <code class="highlighter-rouge">uuid_list</code> (located on the stack as <code class="highlighter-rouge">Uuid uuid_list[1];</code>) would copy an additional <code class="highlighter-rouge">sizeof(Uuid)</code> bytes into the <code class="highlighter-rouge">uuid_filters</code> array for the SDP entry. This data would then be sent if device received a service search attribute response (sdp_discovery.cc:584) and a continuation request is needed (sdp_discovery.cc:563).</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Uuid</span> <span class="n">uuid_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">...</span>
<span class="n">num_uuid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">for</span> <span class="p">(</span><span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">num_uuid</span><span class="p">;</span> <span class="n">xx</span><span class="o">++</span><span class="p">)</span> <span class="n">p_db</span><span class="o">-&gt;</span><span class="n">uuid_filters</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_uuid_list</span><span class="o">++</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sdpu_build_uuid_seq</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">num_uuid_filters</span><span class="p">,</span>
                             <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">uuid_filters</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">L2CA_DataWrite</span><span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">connection_id</span><span class="p">,</span> <span class="n">p_msg</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9504	ID in SDP <a href="https://android.googlesource.com/platform/system/bt/+/11fb7aa03437eccac98d90ca2de1730a02a515e2">diff</a>
    <ul>
      <li>ID in the client while saving response from attacker</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sdp_copy_raw_data</span><span class="p">(</span><span class="n">tCONN_CB</span><span class="o">*</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpy_len</span><span class="p">,</span> <span class="n">rem_len</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">list_len</span><span class="p">;</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">type</span><span class="p">;</span>
<span class="cp">#if (SDP_DEBUG_RAW == TRUE)
</span>  <span class="kt">uint8_t</span> <span class="n">num_array</span><span class="p">[</span><span class="n">SDP_MAX_LIST_BYTE_COUNT</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">num_array</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_array</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"%02X"</span><span class="p">,</span>
             <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">rsp_list</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="p">}</span>
  <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"result :%s"</span><span class="p">,</span> <span class="n">num_array</span><span class="p">);</span>
<span class="cp">#endif
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cpy_len</span> <span class="o">=</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_size</span> <span class="o">-</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_used</span><span class="p">;</span>
    <span class="n">list_len</span> <span class="o">=</span> <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">list_len</span><span class="p">;</span>
     <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">rsp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">cpy_len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span>      <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">old_p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
       <span class="n">p</span> <span class="o">=</span> <span class="n">sdpu_get_len_from_type</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_len</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cpy_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">old_p</span><span class="p">))</span> <span class="p">{</span>
<span class="o">+</span>        <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"%s: no bytes left for data"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>      <span class="n">cpy_len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">old_p</span><span class="p">);</span>
     <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&lt;</span> <span class="n">cpy_len</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cpy_len</span> <span class="o">=</span> <span class="n">list_len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">rem_len</span> <span class="o">=</span> <span class="n">SDP_MAX_LIST_BYTE_COUNT</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">p</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">rsp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cpy_len</span> <span class="o">&gt;</span> <span class="n">rem_len</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SDP_TRACE_WARNING</span><span class="p">(</span><span class="s">"rem_len :%d less than cpy_len:%d"</span><span class="p">,</span> <span class="n">rem_len</span><span class="p">,</span> <span class="n">cpy_len</span><span class="p">);</span>
      <span class="n">cpy_len</span> <span class="o">=</span> <span class="n">rem_len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_used</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">cpy_len</span><span class="p">);</span>
    <span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_db</span><span class="o">-&gt;</span><span class="n">raw_used</span> <span class="o">+=</span> <span class="n">cpy_len</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9355 RCE in SDP while processing data returned when looking up records <a href="https://android.googlesource.com/platform/system/bt/+/99a263a7f04c5c6f101388007baa18cf1e8c30bf">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// stack based buffer overflow - Stack array of arrays which has a set length, but will copy how every many times the client told it to
</span><span class="cm">/*******************************************************************************
 *
 * Function         bta_dm_sdp_result
 *
 * Description      Process the discovery result from sdp
void bta_dm_sdp_result(tBTA_DM_MSG* p_data) {
...
-  uint8_t uuid_list[32][MAX_UUID_SIZE];  // assuming a max of 32 services
+  uint8_t uuid_list[BTA_MAX_SERVICES][MAX_UUID_SIZE];  // assuming a max of 32 services
                 bta_service_id_to_uuid_lkup_tbl[bta_dm_search_cb.service_index -
                                                 1];
             /* Add to the list of UUIDs */</span>
<span class="o">-</span>            <span class="n">sdpu_uuid16_to_uuid128</span><span class="p">(</span><span class="n">tmp_svc</span><span class="p">,</span> <span class="n">uuid_list</span><span class="p">[</span><span class="n">num_uuids</span><span class="p">]);</span>
<span class="o">-</span>            <span class="n">num_uuids</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span>            <span class="k">if</span> <span class="p">(</span><span class="n">num_uuids</span> <span class="o">&lt;</span> <span class="n">BTA_MAX_SERVICES</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>              <span class="n">sdpu_uuid16_to_uuid128</span><span class="p">(</span><span class="n">tmp_svc</span><span class="p">,</span> <span class="n">uuid_list</span><span class="p">[</span><span class="n">num_uuids</span><span class="p">]);</span>
<span class="o">+</span>              <span class="n">num_uuids</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>              <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"74016921"</span><span class="p">);</span>
<span class="o">+</span>            <span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">}</span>
<span class="p">...</span>
             <span class="n">SDP_FindServiceInDb_128bit</span><span class="p">(</span><span class="n">bta_dm_search_cb</span><span class="p">.</span><span class="n">p_sdp_db</span><span class="p">,</span> <span class="n">p_sdp_rec</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">p_sdp_rec</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">SDP_FindServiceUUIDInRec_128bit</span><span class="p">(</span><span class="n">p_sdp_rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_uuid</span><span class="p">))</span> <span class="p">{</span>
<span class="o">-</span>            <span class="n">memcpy</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">[</span><span class="n">num_uuids</span><span class="p">],</span> <span class="n">temp_uuid</span><span class="p">.</span><span class="n">uu</span><span class="p">.</span><span class="n">uuid128</span><span class="p">,</span> <span class="n">MAX_UUID_SIZE</span><span class="p">);</span>
<span class="o">-</span>            <span class="n">num_uuids</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span>            <span class="k">if</span> <span class="p">(</span><span class="n">num_uuids</span> <span class="o">&lt;</span> <span class="n">BTA_MAX_SERVICES</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>              <span class="n">memcpy</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">[</span><span class="n">num_uuids</span><span class="p">],</span> <span class="n">temp_uuid</span><span class="p">.</span><span class="n">uu</span><span class="p">.</span><span class="n">uuid128</span><span class="p">,</span> <span class="n">MAX_UUID_SIZE</span><span class="p">);</span>
<span class="o">+</span>              <span class="n">num_uuids</span><span class="o">++</span><span class="p">;</span>
<span class="o">+</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>              <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"74016921"</span><span class="p">);</span>
<span class="o">+</span>            <span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p_sdp_rec</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2017-13255 SDP RCE <a href="https://android.googlesource.com/platform/system/bt/+/f0edf6571d2d58e66ee0b100ebe49c585d31489f">diff</a></li>
  <li>CVE-2017-13290 SDP ID [diff]https://android.googlesource.com/platform/system/bt/+/72b1cebaa9cc7ace841d887f0d4a4bf6daccde6e)
    <ul>
      <li>The end of the request was never checked. This is the same problem as seen in other areas of the stack, but the approach to fixing is a lot more consistent than other fixes.</li>
      <li>The end of the request is checked accross many different functions with this patch.</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"> <span class="k">static</span> <span class="kt">void</span> <span class="n">process_service_search_attr_req</span><span class="p">(</span><span class="n">tCONN_CB</span><span class="o">*</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">trans_num</span><span class="p">,</span>
                                             <span class="kt">uint16_t</span> <span class="n">param_len</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_req</span><span class="p">,</span>
<span class="o">-</span>                                            <span class="n">UNUSED_ATTR</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_req_end</span><span class="p">);</span>
<span class="o">+</span>                                            <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_req_end</span><span class="p">);</span>

<span class="o">+</span>
<span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_req</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p_req_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"69384124"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">sdpu_build_n_send_error</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">trans_num</span><span class="p">,</span> <span class="n">SDP_INVALID_REQ_SYNTAX</span><span class="p">,</span>
<span class="o">+</span>                            <span class="n">SDP_TEXT_BAD_HEADER</span><span class="p">);</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">param_len</span><span class="p">,</span> <span class="n">p_req</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2017-13259 SDP ID <a href="https://android.googlesource.com/platform/system/bt/+/0627e76edefd948dc3efe11564d7e53d56aac80c">diff</a>
    <ul>
      <li>Similar to CVE-2017-13290 but this fixes reading from the end of the request in the client.</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="n">process_service_search_rsp</span><span class="p">(</span><span class="n">tCONN_CB</span><span class="o">*</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_reply</span><span class="p">,</span>
<span class="o">+</span>                                       <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_reply_end</span><span class="p">);</span>


<span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p_reply</span> <span class="o">+</span> <span class="n">cont_len</span> <span class="o">&gt;</span> <span class="n">p_reply_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"68161546"</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">sdp_disconnect</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">SDP_INVALID_CONT_STATE</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>    <span class="p">}</span></code></pre></figure>

<h1 id="bnep-and-pan">BNEP and PAN</h1>

<h2 id="notable-features-3">Notable Features</h2>
<h3 id="bnep-btstack-btstacksrcclassicbnepc">BNEP (btstack: btstack/src/classic/bnep.c)</h3>
<ul>
  <li>Protocol that PAN operates on. In case some other service wanted to implement some network-esc thing? I have only ever seen PAN use this protocol…</li>
  <li>The protocol is not terribly interesting, most implementations ignore certain parts of the specification because they are literally never used lol (TODO link to linux extension bit).</li>
</ul>

<h3 id="pan">PAN</h3>
<ul>
  <li>Different roles PANU, NU, GN</li>
</ul>

<h2 id="attack-surface-3">Attack Surface</h2>
<p>TODO</p>

<h2 id="cves-4">CVEs</h2>
<ul>
  <li>CVE-2017-0782	(Add a missing check for PAN buffer size before copying data) <a href="https://android.googlesource.com/platform/system/bt/+/4e47f3db62bab524946c46efe04ed6a2b896b150">diff</a> and (Add missing extension length check while parsing BNEP control packets
) <a href="https://android.googlesource.com/platform/system/bt/+/c568fa9088ded964e0ac99db236e612de5d82177">diff</a>
    <ul>
      <li>this code will always overflow (see bluebourne paper)</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">   <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tBTA_PAN_DATA_PARAMS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
     <span class="cm">/* offset smaller than data structure in front of actual data */</span>
<span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">BT_HDR</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tBTA_PAN_DATA_PARAMS</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span>
<span class="o">+</span>        <span class="n">PAN_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"63146237"</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">APPL_TRACE_ERROR</span><span class="p">(</span><span class="s">"%s: received buffer length too large: %d"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
<span class="o">+</span>                       <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">osi_free</span><span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>    <span class="p">}</span>
     <span class="n">p_new_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">BT_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">osi_malloc</span><span class="p">(</span><span class="n">PAN_BUF_SIZE</span><span class="p">);</span>
     <span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_new_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tBTA_PAN_DATA_PARAMS</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2017-0783	(Disable PAN Reverse Tethering when connection originated by the Remote) <a href="https://android.googlesource.com/platform/system/bt/+/1e77fefc8b9c832239e1b32c6a6880376065e24e">diff</a>
    <ul>
      <li>see bluebourne paper</li>
    </ul>
  </li>
  <li>PAN Use after free <a href="https://android.googlesource.com/platform/system/bt/+/08e68337a9eb45818d5a770570c8b1d15a14d904">diff</a>
    <ul>
      <li>Regression described in bluedroid</li>
    </ul>
  </li>
  <li>BNEP ID <a href="https://android.googlesource.com/platform/system/bt/+/a50e70468c0a8d207e416e273d05a08635bdd45f">diff</a>
    <ul>
      <li>Check out the writeup by <a href="https://blog.quarkslab.com/android-bluetooth-vulnerabilities-in-the-march-2018-security-bulletin.html">Quarkslab</a></li>
    </ul>
  </li>
  <li>CVE-2018-9436	ID in BNEP <a href="https://android.googlesource.com/platform/system/bt/+/289a49814aef7f0f0bb98aac8246080abdfeac01">diff</a>
    <ul>
      <li>Length check is missing, you can position <code class="highlighter-rouge">p</code> so that it points to the byte after the packet and if it is &gt; BNEP_FILTER_MULTI_ADDR_RESPONSE_MSG then it will be sent back</li>
      <li>Check out the writeup by <a href="https://blog.quarkslab.com/android-bluetooth-vulnerabilities-in-the-march-2018-security-bulletin.html">Quarkslab</a></li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>        <span class="k">if</span> <span class="p">((</span><span class="n">ext</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">BNEP_EXTENSION_FILTER_CONTROL</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>            <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"79164722"</span><span class="p">);</span>
<span class="o">+</span>            <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>          <span class="p">}</span>
<span class="o">+</span>          <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">BNEP_FILTER_MULTI_ADDR_RESPONSE_MSG</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>            <span class="n">bnep_send_command_not_understood</span><span class="p">(</span><span class="n">p_bcb</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="o">+</span>          <span class="p">}</span>
<span class="o">+</span>        <span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="n">p</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9356	RCE in PAN <a href="https://android.googlesource.com/platform/system/bt/+/d7d4d5686b2e3c37c7bf10a6a2adff1c95251a13">diff</a>
    <ul>
      <li>Fix for UAF?</li>
    </ul>
  </li>
  <li>CVE-2018-9357 RCE in BNEP <a href="https://android.googlesource.com/platform/system/bt/+/9164ee1aaf3609b4771d39302e3af649f44c9e66">diff</a>
    <ul>
      <li>BNEP_Write -&gt; <code class="highlighter-rouge">if (new_len &gt; org_len) return BNEP_IGNORE_CMD;</code> were placed because extension bit could let you make big writes</li>
    </ul>
  </li>
</ul>

<h1 id="avrcp-and-avtdp">AVRCP and AVTDP</h1>

<h2 id="notable-features-4">Notable Features</h2>
<ul>
  <li>Controls audio</li>
</ul>

<h2 id="stack-implementations-1">Stack Implementations</h2>
<ul>
  <li>Need to pair with device to access it on Android</li>
</ul>

<p>Android:
bta_av_api.h:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/* Set to TRUE if seperate authorization prompt desired for AVCTP besides A2DP
 * authorization */</span>
<span class="cm">/* Typically FALSE when AVRCP is used in conjunction with A2DP */</span>
<span class="cp">#ifndef BTA_AV_WITH_AVCTP_AUTHORIZATION</span></code></pre></figure>

<h2 id="cves-5">CVEs</h2>
<h3 id="android-2">Android</h3>
<ul>
  <li>CVE-2017-13281 really good length check in AVRCP <a href="https://android.googlesource.com/platform/system/bt/+/6f3ddf3f5cf2b3eb52fb0adabd814a45cff07221%5E%21/">diff</a>
    <ul>
      <li>length check, but it is just plain wrong lol</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">-</span>        <span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">str_len</span><span class="p">)</span>
<span class="o">-</span>          <span class="n">buf_len</span> <span class="o">=</span> <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">str_len</span><span class="p">;</span>
<span class="o">+</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">str_len</span> <span class="o">&gt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">str_len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
<span class="o">+</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"63146237"</span><span class="p">);</span>
<span class="o">+</span>        <span class="p">}</span></code></pre></figure>

<ul>
  <li>CVE-2019-1996	AVRCP ID <a href="https://android.googlesource.com/platform/system/bt/+/525bdbd6e1295ed8a081d2ae87105c64d6f1ac4f">diff</a>
No length checks</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>            <span class="n">min_len</span> <span class="o">+=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">AVRC_FEATURE_MASK_SIZE</span><span class="p">;</span>
<span class="o">+</span>            <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">)</span> <span class="k">goto</span> <span class="n">browse_length_error</span><span class="p">;</span>
             <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">player_len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
             <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">player_id</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
             <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">major_type</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
             <span class="n">BE_STREAM_TO_UINT32</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">sub_type</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
             <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">play_status</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
             <span class="n">BE_STREAM_TO_ARRAY</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">player</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">AVRC_FEATURE_MASK_SIZE</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9588	AVDP ID <a href="https://android.googlesource.com/platform/system/bt/+/bf9ff0c5215861ab673e211cd06e009f3157aab2">diff</a>
    <ul>
      <li>This is a juicy info leak</li>
      <li>No length checks</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>        <span class="n">min_len</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
<span class="o">+</span>        <span class="k">if</span> <span class="p">(</span><span class="n">min_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"111450156"</span><span class="p">);</span>
<span class="o">+</span>          <span class="n">AVDT_TRACE_WARNING</span><span class="p">(</span>
<span class="o">+</span>              <span class="s">"%s: hdl packet length %d too short: must be at least %d"</span><span class="p">,</span>
<span class="o">+</span>              <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">min_len</span><span class="p">);</span>
<span class="o">+</span>          <span class="k">goto</span> <span class="n">avdt_scb_hdl_report_exit</span><span class="p">;</span>
<span class="o">+</span>        <span class="p">}</span>
         <span class="n">BE_STREAM_TO_UINT32</span><span class="p">(</span><span class="n">report</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">ntp_sec</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
         <span class="n">BE_STREAM_TO_UINT32</span><span class="p">(</span><span class="n">report</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">ntp_frac</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
         <span class="n">BE_STREAM_TO_UINT32</span><span class="p">(</span><span class="n">report</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">rtp_time</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9542	ID in AVRCP <a href="https://android.googlesource.com/platform/system/bt/+/cc364611362cc5bc896b400bdc471a617d1ac628">diff</a>
No length checks are performed</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"111450531"</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">AVRC_TRACE_WARNING</span><span class="p">(</span><span class="s">"%s: invalid parameter length %d: must be at least 1"</span><span class="p">,</span>
<span class="o">+</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">return</span> <span class="n">AVRC_STS_INTERNAL_ERR</span><span class="p">;</span>
<span class="o">+</span>    <span class="p">}</span>
     <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2017-13283 RCE (Easy to exploit) <a href="https://android.googlesource.com/platform/system/bt/+/ebc284cf3a59ee5cf7c06af88c2f3bcd0480e3e9">diff</a>
    <ul>
      <li>Read length from packet is not properly verified. This controls data being read into an allocation.</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c">       <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_values</span><span class="p">.</span><span class="n">num_val</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">if</span> <span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_values</span><span class="p">.</span><span class="n">num_val</span> <span class="o">&gt;</span> <span class="n">AVRC_MAX_APP_ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"78526423"</span><span class="p">);</span>
<span class="o">+</span>        <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_values</span><span class="p">.</span><span class="n">num_val</span> <span class="o">=</span> <span class="n">AVRC_MAX_APP_ATTR_SIZE</span><span class="p">;</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>
       <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_values</span><span class="p">.</span><span class="n">num_val</span><span class="p">;</span> <span class="n">xx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_values</span><span class="p">.</span><span class="n">vals</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
      <span class="p">}</span></code></pre></figure>

<ul>
  <li>CVE-2018-9506	ID in AVRCP <a href="https://android.googlesource.com/platform/system/bt/+/830cb39cb2a0f1bf6704d264e2a5c5029c175dd7">diff</a>
    <ul>
      <li>No length check</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">AVRC_AVC_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"111803925"</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">AVRC_TRACE_WARNING</span><span class="p">(</span><span class="s">"%s: message length %d too short: must be at least %d"</span><span class="p">,</span>
<span class="o">+</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">AVRC_AVC_HDR_SIZE</span><span class="p">);</span>
<span class="o">+</span>      <span class="n">osi_free</span><span class="p">(</span><span class="n">p_pkt</span><span class="p">);</span>
<span class="o">+</span>      <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>    <span class="p">}</span>
     <span class="n">msg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">p_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AVRC_CTYPE_MASK</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9507	ID in AVRCP <a href="https://android.googlesource.com/platform/system/bt/+/30cec963095366536ca0b1306089154e09bfe1a9">diff</a>
    <ul>
      <li>No length check</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p_vendor</span><span class="o">-&gt;</span><span class="n">vendor_len</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"111893951"</span><span class="p">);</span>
<span class="o">+</span>          <span class="n">p_rc_rsp</span><span class="o">-&gt;</span><span class="n">get_caps</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">AVRC_STS_INTERNAL_ERR</span><span class="p">;</span>
<span class="o">+</span>          <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>        <span class="p">}</span>
         <span class="n">u8</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p_vendor</span><span class="o">-&gt;</span><span class="n">p_vendor_data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
         <span class="n">p</span> <span class="o">=</span> <span class="n">p_vendor</span><span class="o">-&gt;</span><span class="n">p_vendor_data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
         <span class="n">p_rc_rsp</span><span class="o">-&gt;</span><span class="n">get_caps</span><span class="p">.</span><span class="n">capability_id</span> <span class="o">=</span> <span class="n">u8</span><span class="p">;</span>
         <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>CVE-2018-9450	RCE <a href="https://android.googlesource.com/platform/system/bt/+/bc259b4926a6f9b33b9ee2c917cd83a55f360cbf">diff</a>
since the original packet is being reused, we are copying a certain number of bytes past the end?
not too sure about this one</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">avrc_proc_vendor_command</span>
   <span class="nf">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AVRC_STS_NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>    <span class="cm">/* use the current GKI buffer to build/send the reject message */</span>
<span class="o">-</span>    <span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_pkt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">p_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="n">BT_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">osi_malloc</span><span class="p">(</span><span class="n">BT_DEFAULT_BUFFER_SIZE</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">p_rsp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">p_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_rsp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
     <span class="o">*</span><span class="n">p_data</span><span class="o">++</span> <span class="o">=</span> <span class="n">AVRC_RSP_REJ</span><span class="p">;</span>
     <span class="n">p_data</span> <span class="o">+=</span> <span class="n">AVRC_VENDOR_HDR_SIZE</span><span class="p">;</span> <span class="cm">/* pdu */</span>
     <span class="o">*</span><span class="n">p_data</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  <span class="cm">/* pkt_type */</span>
     <span class="n">UINT16_TO_BE_STREAM</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* len */</span>
     <span class="o">*</span><span class="n">p_data</span><span class="o">++</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>             <span class="cm">/* error code */</span>
<span class="o">-</span>    <span class="n">p_pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">AVRC_VENDOR_HDR_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
<span class="o">-</span>    <span class="n">p_rsp</span> <span class="o">=</span> <span class="n">p_pkt</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">p_rsp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">AVRC_VENDOR_HDR_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
   <span class="p">}</span></code></pre></figure>

<ul>
  <li>CVE-2018-9540	ID - “In avrc_ctrl_pars_vendor_rsp of avrc_pars_ct.c, there is a possible out of bounds read due to a missing bounds check.” <a href="https://android.googlesource.com/platform/system/bt/+/99d54d0c7dbab6c80f15bbf886ed203b2a547453">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">-</span><span class="kt">void</span> <span class="n">avrc_parse_notification_rsp</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_stream</span><span class="p">,</span>
<span class="o">-</span>                                 <span class="n">tAVRC_REG_NOTIF_RSP</span><span class="o">*</span> <span class="n">p_rsp</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span><span class="n">tAVRC_STS</span> <span class="n">avrc_parse_notification_rsp</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_stream</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">,</span>
<span class="o">+</span>                                      <span class="n">tAVRC_REG_NOTIF_RSP</span><span class="o">*</span> <span class="n">p_rsp</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>  <span class="kt">uint16_t</span> <span class="n">min_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">)</span> <span class="k">goto</span> <span class="n">length_error</span><span class="p">;</span>
   <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_rsp</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">,</span> <span class="n">p_stream</span><span class="p">);</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">p_rsp</span><span class="o">-&gt;</span><span class="n">event_id</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">case</span> <span class="n">AVRC_EVT_PLAY_STATUS_CHANGE</span><span class="p">:</span>
<span class="o">+</span>      <span class="n">min_len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="o">+</span>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">)</span> <span class="k">goto</span> <span class="n">length_error</span><span class="p">;</span>
       <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_rsp</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">play_status</span><span class="p">,</span> <span class="n">p_stream</span><span class="p">);</span>
       <span class="k">break</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>(CVE-2017-13266) RCE <a href="https://android.googlesource.com/platform/system/bt/+/6ecbbc093f4383e90cbbf681cd55da1303a8ef94">diff</a></li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">tAVRC_STS</span> <span class="nf">avrc_ctrl_pars_vendor_rsp</span><span class="p">(</span><span class="n">tAVRC_MSG_VENDOR</span><span class="o">*</span> <span class="n">p_msg</span><span class="p">,</span>
                                           <span class="n">tAVRC_RESPONSE</span><span class="o">*</span> <span class="n">p_result</span><span class="p">,</span>
                                           <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p_buf</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="o">*</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">p_vendor_data</span><span class="p">;</span>
  <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">pdu</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
  <span class="n">p</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* skip the reserved/packe_type byte */</span>
  <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">BE_STREAM_TO_UINT16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
  <span class="n">AVRC_TRACE_DEBUG</span><span class="p">(</span><span class="s">"%s ctype:0x%x pdu:0x%x, len:%d"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ctype</span><span class="p">,</span>
                   <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">pdu</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="cm">/* Todo: Issue in handling reject, check */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">AVRC_RSP_REJ</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* TODO: Break the big switch into functions. */</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">pdu</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">AVRC_PDU_LIST_PLAYER_APP_ATTR</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
      <span class="n">AVRC_TRACE_DEBUG</span><span class="p">(</span><span class="s">"%s attr count = %d "</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
                       <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span> <span class="o">&gt;</span> <span class="n">AVRC_MAX_APP_ATTR_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"63146237"</span><span class="p">);</span>
        <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span> <span class="o">=</span> <span class="n">AVRC_MAX_APP_ATTR_SIZE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">num_attr</span><span class="p">;</span> <span class="n">xx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">BE_STREAM_TO_UINT8</span><span class="p">(</span><span class="n">p_result</span><span class="o">-&gt;</span><span class="n">list_app_attr</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">xx</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9448	ID in AVRCP <a href="https://android.googlesource.com/platform/system/bt/+/13294c70a66347c9e5d05b9f92f8ceb6fe38d7f6">diff</a>
    <ul>
      <li>No length check</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">AVCT_HDR_LEN_SINGLE</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">AVCT_TRACE_WARNING</span><span class="p">(</span><span class="s">"Invalid AVCTP packet length %d: must be at least %d"</span><span class="p">,</span>
<span class="o">+</span>                       <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">AVCT_HDR_LEN_SINGLE</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">osi_free_and_reset</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_buf</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"79944113"</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span></code></pre></figure>

<ul>
  <li>CVE-2018-9453	ID in AVDTP <a href="https://android.googlesource.com/platform/system/bt/+/cb6a56b1d8cdab7c495ea8f53dcbdb3cfc9477d2">diff</a>
    <ul>
      <li>Possible RCE?</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">elem_len</span> <span class="o">&gt;</span> <span class="n">p_end</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">err</span> <span class="o">=</span> <span class="n">AVDT_ERR_LENGTH</span><span class="p">;</span>
<span class="o">+</span>          <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"78288378"</span><span class="p">);</span>
<span class="o">+</span>          <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>        <span class="p">}</span></code></pre></figure>

<h1 id="att-and-gatt">ATT and GATT</h1>

<h2 id="notable-features-5">Notable features</h2>
<ul>
  <li>ATT and GATT are kind of tied into each other</li>
  <li>It is basically a glorified database which uses UUIDs to identify elements to read and/or write</li>
  <li>Service, characteristics, attributes</li>
</ul>

<h2 id="attack-surface-4">Attack surface</h2>
<ul>
  <li>The code for each off the different actions is relatively limited in what it does (hence the “low energy”). So for as far as exploiting the GATT protocol, there is little room for vulnerabilities to be introduced.</li>
  <li>There is a lot of research published on exploiting applications which use GATT (bleah) by identifying information that is exposed and properties that are able to be written to.</li>
  <li>A really cool challenge that you can try out to learn about BLE application layer hacking is here: https://github.com/hackgnar/ble_ctf</li>
</ul>

<h2 id="cves-6">CVEs</h2>

<h3 id="android-3">Android</h3>
<ul>
  <li>CVE-2017-13160 bta gattc Priv esc? <a href="https://android.googlesource.com/platform/system/bt/+/68a1cf1a9de115b66bececf892588075595b263f">diff</a>
    <ul>
      <li>Loads GATT cache with incorrect size</li>
    </ul>
  </li>
  <li>CVE-2018-9358	UNUSED_ATTR in length for gatt <a href="https://android.googlesource.com/platform/system/bt/+/0d7c2f5a14d1055f3b4f69035451c66bf8f1b08e">diff</a>
    <ul>
      <li>len is not used</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
<span class="o">+</span>    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s">"73172115"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">__func__</span> <span class="o">&lt;&lt;</span> <span class="s">"invalid length"</span><span class="p">;</span>
<span class="o">+</span>    <span class="n">gatt_send_error_rsp</span><span class="p">(</span><span class="n">tcb</span><span class="p">,</span> <span class="n">GATT_INVALID_PDU</span><span class="p">,</span> <span class="n">GATT_REQ_EXEC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="o">+</span>    <span class="k">return</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="n">STREAM_TO_UINT8</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span></code></pre></figure>

<h1 id="conclusions">Conclusions</h1>
<ul>
  <li>Security is hard, especially when you are implementing code to match a specification that has a number of protocols some legacy, some new.</li>
  <li>When you are parsing data, for the love of god, properly keep track of where you are. Linux and iOS do this well by having the position in the packet always being kept updated and checked. Android fails to do this and is the root cause of the majority of the CVEs that have been reported.</li>
</ul>

<h2 id="attack-surface-5">Attack surface</h2>
<ul>
  <li>Following the <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-121r2.pdf">guidelines put forth by NIST</a>, a Bluetooth stack can take some steps to become secure to the passer by attacker. While a Bluetooth social engineering attack (prompting the user to pair a device) can open up the attack surface to other protocols, it does put at least some barrier to protect devices from rampantly spreading malware.</li>
</ul>

<h2 id="vulnerability-patterns">Vulnerability Patterns</h2>
<ul>
  <li>It is important to identify vulnerability trends and cut the head off the Hydra before you have new ones. As seen in reported Bluetooth vulnerabilities in Android, the head was not cut off. You have patches which fix a vulnerability, but create a new one (BNEP UAF), lack of length checks (all the information disclosures), and overall neglect of properly checking lengths in general (AVCTP length check, the bnep off by one).</li>
  <li><a href="https://security.googleblog.com/2019/05/queue-hardening-enhancements.html">Google’s blog post</a> about security improvements in Android Q was very exciting since they are using data drive their security efforts in creating analyses which stop bug pattens like these.</li>
</ul>

  </div>

</article>

        </div>
      </div>

      <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <div class="social-media-list">
          
            <a href="mailto:chris@vgcs.io">Email</a>
          

          
            <a href="https://github.com/breadchris">Github</a>
          

          
            <a href="https://twitter.com/breadchris">Twitter</a>
          
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <p>Theme made by <a href="http://masha.space/">Masha Safina</a>. Codes available on <a href="https://github.com/mashlo/captains-log">GitHub</a> 🖖</p>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>

</html>
